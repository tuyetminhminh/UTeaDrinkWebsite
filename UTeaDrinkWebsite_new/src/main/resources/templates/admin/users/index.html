<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/admin-layout :: adminLayout(~{::title}, ~{::content})}">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet">
    <style>

        /* d√πng c√°c bi·∫øn m√†u ƒë√£ c√≥ t·ª´ header; n·∫øu ch∆∞a c√≥, v·∫´n ·ªïn v√¨ d∆∞·ªõi ƒë√¢y ƒë·ªÅu l√† m√†u t·ª± c√≥ */
        .badge-role {
            font-weight: 700;
            letter-spacing: .3px;
            border: 1px solid var(--border, rgba(0, 0, 0, .12));
            font-size: .75rem;
        }

        /* m√†u r√µ, t∆∞∆°ng ph·∫£n t·ªët ·ªü c·∫£ 2 theme */
        .role-admin {
            background: #111;
            color: #fff;
        }

        .role-manager {
            background: #0f766e;
            color: #fff;
        }

        .role-seller {
            background: #7c3aed;
            color: #fff;
        }

        .role-shipper {
            background: #2563eb;
            color: #fff;
        }

        .role-customer {
            background: #facc15;
            color: #111;
        }

        /* n·∫øu ·ªü dark theme, badge v√†ng v·∫´n ƒë·ªÉ ch·ªØ ƒëen cho d·ªÖ ƒë·ªçc */
        [data-bs-theme="dark"] .role-customer {
            background: #facc15;
            color: #111;
        }
    </style>
</head>
<body>
<div th:fragment="content">

<div th:replace="~{fragments/breadcrumbs ::
  bc('Trang ch·ªß', @{/admin/home},
     null, null,
     'Ng∆∞·ªùi d√πng')
}"></div>

    <div class="container-fluid p-0">
 
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>
            <button class="btn btn-primary" data-bs-toggle="modal"
                    data-bs-target="#createModal">+ Th√™m ng∆∞·ªùi d√πng</button>
        </div>

        <!-- Alerts -->
        <div th:if="${success}" class="alert alert-success"
             th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <!-- Search -->
        <form class="row g-2 mb-3" method="get" th:action="@{/admin/users}">
            <div class="col-auto">
                <input class="form-control" name="kw" th:value="${kw}"
                       placeholder="T√¨m theo email / t√™n">
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-secondary">T√¨m ki·∫øm</button>
            </div>
        </form>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Username</th>
                    <th>H·ªç t√™n</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Vai tr√≤</th>
                    <th style="width: 240px">Thao t√°c</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="u : ${page.content}">
                    <td th:text="${u.id}"></td>
                    <td th:text="${u.email}"></td>
                    <td th:text="${u.username}"></td>
                    <td th:text="${u.fullName}"></td>
                    <td><span
                            th:classappend="${u.status=='ACTIVE'} ? 'badge bg-success' : (${u.status=='LOCKED'} ? 'badge bg-danger' : 'badge bg-secondary')"
                            th:text="${u.status}"></span></td>
                    <td><span th:each="r : ${u.roles != null ? u.roles : {}}"
                              th:text="${#strings.toUpperCase(r.code)}"
                              th:class="${'badge badge-role me-1 ' +
                   (#strings.equalsIgnoreCase(r.code,'ADMIN')   ? 'role-admin'   :
                    #strings.equalsIgnoreCase(r.code,'MANAGER') ? 'role-manager' :
                    #strings.equalsIgnoreCase(r.code,'SELLER')  ? 'role-seller'  :
                    #strings.equalsIgnoreCase(r.code,'SHIPPER') ? 'role-shipper' :
                    'role-customer')}">
						</span></td>

                    <td>
                        <!-- S·ª≠a -->
                        <button class="btn btn-sm btn-outline-primary me-1"
                                data-bs-toggle="modal" data-bs-target="#editModal"
                                th:attr="data-id=${u.id},
						                 data-email=${u.email},
						                 data-username=${u.username},
						                 data-fullname=${u.fullName},
						                 data-role=${(u.roles == null or #sets.isEmpty(u.roles))
                      ? ''
                      : u.roles.iterator().next().code}">
                            S·ª≠a</button> <!-- Kh√≥a/M·ªü -->
                        <form th:if="${u.status=='ACTIVE'}" class="d-inline"
                              method="post" th:action="@{'/admin/users/' + ${u.id} + '/lock'}">
                            <button class="btn btn-sm btn-outline-warning">Kh√≥a</button>
                        </form>
                        <form th:if="${u.status=='LOCKED'}" class="d-inline"
                              method="post"
                              th:action="@{'/admin/users/' + ${u.id} + '/unlock'}">
                            <button class="btn btn-sm btn-outline-success">M·ªü</button>
                        </form> <!-- Reset MK -->
                        <button class="btn btn-sm btn-outline-secondary ms-1"
                                data-bs-toggle="modal" data-bs-target="#resetModal"
                                th:attr="data-id=${u.id},data-email=${u.email}">Reset
                            MK</button> <!-- X√≥a -->
                        <form class="d-inline ms-1" method="post"
                              th:action="@{'/admin/users/' + ${u.id} + '/delete'}"
                              onsubmit="return confirm('X√≥a ng∆∞·ªùi d√πng n√†y?');">
                            <button class="btn btn-sm btn-outline-danger">X√≥a</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav th:if="${page.totalPages > 1}">
            <ul class="pagination">
                <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{|/admin/users?page=${page.number}&size=${page.size}&kw=${kw}|}">¬´</a>
                </li>
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(1, page.totalPages)}"
                    th:classappend="${i == page.number + 1} ? 'active'"><a
                        class="page-link" th:text="${i}"
                        th:href="@{|/admin/users?page=${i}&size=${page.size}&kw=${kw}|}"></a>
                </li>
                <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{|/admin/users?page=${page.number + 2}&size=${page.size}&kw=${kw}|}">¬ª</a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Create Modal -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" method="post"
                  th:action="@{/admin/users/create}">
                <div class="modal-header">
                    <h5 class="modal-title">Th√™m ng∆∞·ªùi d√πng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="modal-label">Email *</label> <input
                            class="form-control" name="email" required>
                    </div>
                    <div class="mb-2">
                        <label class="modal-label">Username</label> <input
                            class="form-control" name="username">
                    </div>
                    <div class="mb-2">
                        <label class="modal-label">H·ªç t√™n</label> <input
                            class="form-control" name="fullName">
                    </div>
                    <div class="mb-2">
                        <label class="modal-label">M·∫≠t kh·∫©u *</label> <input type="text"
                                                                             class="form-control" name="password" required>
                    </div>
                    <div class="mb-2">
                        <label class="modal-label">Vai tr√≤</label>
                        <div class="d-flex flex-wrap gap-3">
                            <div th:each="r : ${rolesAll}" class="form-check">
                                <input class="form-check-input" type="radio" name="role"
                                       th:value="${r.code}" th:id="${'cr_'+r.code}"> <label
                                    class="form-check-label" th:for="${'cr_'+r.code}"
                                    th:text="${r.code}"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button"
                            data-bs-dismiss="modal">H·ªßy</button>
                    <button class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    <div class="mb-2">
                        <label class="modal-label">Email</label> <input
                            class="form-control" id="edit-email" disabled>
                    </div>
                    <div class="mb-2">
                        <label class="modal-label">Username</label> <input
                            class="form-control" name="username" id="edit-username">
                    </div>
                    <div class="mb-2">
                        <label class="modal-label">H·ªç t√™n</label> <input
                            class="form-control" name="fullName" id="edit-fullname">
                    </div>
                    <div class="mb-2">
                        <label class="modal-label">Vai tr√≤</label>
                        <div class="d-flex flex-wrap gap-3">
                            <div th:each="r : ${rolesAll}" class="form-check">
                                <input class="form-check-input edit-role" type="radio"
                                       name="role" th:value="${r.code}" th:id="${'ed_'+r.code}">
                                <label class="form-check-label" th:for="${'ed_'+r.code}"
                                       th:text="${r.code}"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button"
                            data-bs-dismiss="modal">H·ªßy</button>
                    <button class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reset-id">
                    <div class="mb-2">
                        <label class="modal-label">Email</label> <input
                            class="form-control" id="reset-email" disabled>
                    </div>
                    <div class="mb-2">
                        <label class="modal-label">M·∫≠t kh·∫©u m·ªõi</label> <input
                            class="form-control" name="newPassword" id="reset-pass" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button"
                            data-bs-dismiss="modal">H·ªßy</button>
                    <button class="btn btn-primary">X√°c nh·∫≠n</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', function (event) {
        const btn = event.relatedTarget;
        const id = btn.getAttribute('data-id');
        const email = btn.getAttribute('data-email');
        const username = btn.getAttribute('data-username') || '';
        const fullname = btn.getAttribute('data-fullname') || '';
        const role = (btn.getAttribute('data-role') || '').trim();

        this.querySelector('form').setAttribute('action', '/admin/users/' + id + '/update');
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-email').value = email;
        document.getElementById('edit-username').value = username;
        document.getElementById('edit-fullname').value = fullname;

        this.querySelectorAll('.edit-role').forEach(rb => {
            rb.checked = (rb.value === role);
        });
    });

    const resetModal = document.getElementById('resetModal');
    resetModal.addEventListener('show.bs.modal', function (event) {
        const btn = event.relatedTarget;
        const id = btn.getAttribute('data-id');
        const email = btn.getAttribute('data-email');
        document.getElementById('reset-id').value = id;
        document.getElementById('reset-email').value = email;
        this.querySelector('form').setAttribute('action', '/admin/users/' + id + '/reset-password');
    });
</script>
</body>
</html>
