<!-- src/main/resources/templates/chat/manager-inbox.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Hộp thư khách hàng</title>

    <!-- Bootstrap & Icons via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <style>
        :root{
            --bg:#0f172a; --bg-2:#0b1227; --card:#0b1227;
            --muted:#94a3b8; --text:#e2e8f0;
            --primary:#6366f1; --primary-2:#4f46e5;
            --bubble:#101936; --bubble-me:#1e293b;
            --border:rgba(148,163,184,.12);
            --hover:rgba(148,163,184,.08); --active:rgba(99,102,241,.18);
            --shadow:0 10px 30px rgba(2,6,23,.35);
        }

        html,body{scroll-behavior:smooth;}
        body{
            background: radial-gradient(1200px 1200px at 85% -200px, rgba(99,102,241,.18), transparent 60%),
            radial-gradient(900px 900px at -100px 50%, rgba(20,184,166,.14), transparent 60%),
            var(--bg);
            color: var(--text); min-height:100vh;
        }

        .chat-shell{
            height: calc(100vh - 32px);
            margin: 16px; border-radius: 18px; overflow: hidden;
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
            border: 1px solid var(--border); box-shadow: var(--shadow);
            display: grid; grid-template-columns: 340px 1fr;
            /* cho phép con có vùng cuộn hoạt động */
            min-height: 0;
        }

        /* ===== Left pane ===== */
        .left-pane{
            display:grid; grid-template-rows:auto 1fr;
            background: linear-gradient(180deg, rgba(15,23,42,.8), rgba(11,18,39,.92));
            border-right:1px solid var(--border); backdrop-filter: blur(6px);
            min-height: 0;
        }
        .left-head{
            padding:16px; border-bottom:1px solid var(--border);
            display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
        }
        .left-head .state-dot{font-size:12px;color:var(--muted);}
        .conv-list{overflow:auto; padding:8px; min-height:0;}
        .conv-item{
            display:grid; grid-template-columns:42px 1fr auto; gap:12px; align-items:center;
            padding:10px 12px; border-radius:12px; cursor:pointer; transition:.2s ease;
        }
        .conv-item:hover{background:var(--hover);}
        .conv-item.active{background:var(--active);}
        .avatar{
            width:42px;height:42px;border-radius:50%;display:grid;place-items:center;
            background:linear-gradient(135deg,#22d3ee33,#6366f133); color:#a5b4fc;font-weight:700;
            border:1px solid var(--border);
        }
        .conv-name{font-weight:600; line-height:1.2;}
        .conv-snippet{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .conv-time{color:var(--muted); font-size:12px;}
        .unread-badge{
            background:linear-gradient(135deg, #ef4444, #dc2626);
            color:#fff; font-size:11px; font-weight:700;
            padding:2px 7px; border-radius:12px; min-width:20px;
            display:inline-block; text-align:center;
            box-shadow:0 2px 8px rgba(239,68,68,.4);
        }
        .conv-item.unread{border-left:3px solid #ef4444;}

        /* ===== Right pane ===== */
        .right-pane{
            display:grid; grid-template-rows:auto 1fr auto;
            background: linear-gradient(180deg, rgba(11,18,39,.92), rgba(10,15,30,.97));
            position: relative; /* để đặt nút nổi */
            min-height: 0;
        }
        .right-head{
            padding:16px 20px; border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:12px;
        }
        .title{font-size:18px; font-weight:700; margin:0;}
        .title small{color:var(--muted); font-weight:500;}

        .messages{
            padding:18px 20px; overflow:auto;
            display:flex; flex-direction:column; gap:8px;
            min-height: 0; /* quan trọng để cuộn được trong grid */
        }
        .msg{display:flex; gap:10px;}
        .msg.me{justify-content:flex-end;}
        .bubble{
            max-width:72%; padding:10px 12px; border-radius:14px;
            background:var(--bubble); border:1px solid var(--border);
            box-shadow:0 6px 18px rgba(2,6,23,.25); animation:pop .2s ease;
        }
        .msg.me .bubble{background:var(--bubble-me); border-color:rgba(99,102,241,.25);}
        .bubble small{color:var(--muted); display:block; margin-top:6px;}
        .status{
            align-self:center; background:#0b1227; border:1px dashed var(--border);
            color:var(--muted); padding:6px 10px; border-radius:999px; font-size:12px; margin:8px 0 12px;
        }
        @keyframes pop{from{transform:scale(.98);opacity:.6} to{transform:scale(1);opacity:1}}

        .composer{
            border-top:1px solid var(--border); padding:14px;
            display:grid; grid-template-columns:1fr auto; gap:10px;
            background:linear-gradient(180deg, rgba(15,23,42,.8), rgba(15,23,42,.6));
            backdrop-filter: blur(6px);
        }
        .input-wrap{
            background:#0c152f; border:1px solid var(--border); border-radius:12px;
            display:flex; align-items:center; gap:8px; padding:8px 10px;
        }
        .input-wrap input{all:unset; color:var(--text); width:100%; font-size:14px;}
        .icon-btn{
            width:38px;height:38px;display:grid;place-items:center;border:1px solid var(--border);
            border-radius:10px;background:#0c152f;color:var(--muted);transition:.2s;
        }
        .icon-btn:hover{border-color:#7c3aed66;color:#a78bfa;background:#0f1836;}
        .send-btn{
            padding:10px 16px;border-radius:12px;border:1px solid #7c3aed66;
            background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff;font-weight:600;
            box-shadow:0 8px 20px rgba(79,70,229,.35); transition:.2s;
        }
        .send-btn:disabled{filter:grayscale(.5);opacity:.6;box-shadow:none;}
        .send-btn:hover{transform:translateY(-1px);}

        /* Scrollbars */
        .conv-list::-webkit-scrollbar, .messages::-webkit-scrollbar{width:8px;height:8px;}
        .conv-list::-webkit-scrollbar-thumb, .messages::-webkit-scrollbar-thumb{background:rgba(148,163,184,.25);border-radius:999px;}

        /* Floating jump-to-bottom button */
        .jump-bottom{
            position:absolute; right:20px; bottom:90px; z-index:3; display:none;
        }

        /* Responsive */
        @media (max-width: 992px){
            .chat-shell{grid-template-columns:1fr;}
            .left-pane{display:none;}
        }
    </style>
</head>
<body>

<div class="chat-shell">
    <!-- LEFT -->
    <aside class="left-pane">
        <div class="left-head">
            <div class="input-group input-group-sm">
        <span class="input-group-text bg-transparent text-secondary border-0">
          <i class="bi bi-search"></i>
        </span>
                <input class="form-control bg-transparent text-light border-0" placeholder="Tìm khách hàng...">
            </div>
            <div class="state-dot" id="connState">Đang kết nối…</div>
        </div>

        <div class="conv-list" id="convList">
            <div class="text-center text-secondary py-3">Đang tải hội thoại...</div>
        </div>
    </aside>

    <!-- RIGHT -->
    <section class="right-pane">
        <div class="right-head">
            <div>
                <h6 class="title mb-0" id="chatTitle">Chưa chọn hội thoại</h6>
                <small class="text-secondary">Hỗ trợ khách hàng theo thời gian thực</small>
            </div>
            <div class="ms-auto d-flex gap-2">
                <button class="icon-btn" title="Làm mới" onclick="location.reload()">
                    <i class="bi bi-arrow-repeat"></i>
                </button>
            </div>
        </div>

        <div id="messages" class="messages"></div>
        <!-- nút xuống cuối -->
        <button id="jumpBottom" class="btn btn-sm btn-dark border jump-bottom">
            Xuống cuối <i class="bi bi-arrow-down-short"></i>
        </button>

        <div class="composer">
            <div class="input-wrap">
                <button class="icon-btn" type="button" title="Đính kèm"><i class="bi bi-paperclip"></i></button>
                <input id="messageInput" placeholder="Nhập tin nhắn..." disabled/>
                <button class="icon-btn" type="button" title="Emoji"><i class="bi bi-emoji-smile"></i></button>
            </div>
            <button id="sendBtn" class="send-btn" disabled>Gửi <i class="bi bi-send ms-1"></i></button>
        </div>
    </section>
</div>

<!-- SockJS + STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- Thymeleaf: id user -->
<script th:inline="javascript">window.CURRENT_USER_ID = [[${me.id}]];</script>

<!-- Audio notification -->
<audio id="notifSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ0PVa3m7q5aGAc+ltrywnUmBSh+zPDajzsIGWW59+qcTwwNU6zl8LJiFgo8kdjzxnksBSWAy/DblEAKE1y16OqlUxEKRp3f8r5rIAU1iti4xngvBymFzvPcizcIG2u/7+GXUQ0PVa3m7qxaFwg9l9ryw3UmBSh+zPDajzsJGWW59+qcTwwNU6zl8LJiFgo8kdjzxnksBSWAy/DbkEAKE1y16OqlUxEKRZzf8r1rIAU1iti4x3cvBymFzvPcizcIG2u/7+GXUQ0PVa3m7qxaFwg9l9ryw3UmBSh+zPDajzsJGWW59+qcTwwNU6zl8LJiFgo8kdjzxnksBSWAy/DbkEAKE1y16OqlUxEKRZzf8r1rIAU1iti4x3cvBymFzvPcizcIG2u/7+GXUQ0PVa3m7qxaFwg9l9ryw3UmBSh+zPDajzsJGWW59+qcTwwNU6zl8LJiFgo8kdjzxnksBSWAy/DbkEAKE1y16OqlUxEKRZzf8r1rIAU1iti4x3cvBymFzvPcizcIG2u/7+GXUQ0PVa3m7qxaFwg9l9ryw3UmBSh+zPDajzsJGWW59+qcTwwNU6zl8LJiFgo8kdjzxnksBSWAy/DbkEAKE1y16OqlUxEKRZzf8r1rIAU1iti4x3cvBymFzvPcizcIG2u/7+GXUQ0PVa3m7qxaFwg9l9ryw3UmBSh+zPDajzsJGWW59+qcTwwNU6zl8LJiFgo8kdjzxnksBSWAy/DbkEAKE1y16OqlUxEK" type="audio/wav">
</audio>

<script>
    (function(){
        let stomp = null, conversationId = null, connected = false;
        const $list = document.getElementById('convList');
        const $msgs = document.getElementById('messages');
        const $title = document.getElementById('chatTitle');
        const $input = document.getElementById('messageInput');
        const $send  = document.getElementById('sendBtn');
        const $state = document.getElementById('connState');
        const $jump  = document.getElementById('jumpBottom');
        const $audio = document.getElementById('notifSound');
        let convSub = null, globalSub = null;

        function setState(text){ if($state) $state.textContent = text; }
        function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
        function initials(name){ if(!name) return 'U'; return name.trim().split(/\s+/).map(p=>p[0]).slice(0,2).join('').toUpperCase(); }
        function timeHHmm(d){ try{ return new Date(d).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); } catch(_){ return ''; } }

        function isAtBottom(){
            return Math.abs($msgs.scrollHeight - $msgs.scrollTop - $msgs.clientHeight) < 8;
        }
        function scrollToBottom(){
            $msgs.scrollTop = $msgs.scrollHeight;
        }

        $msgs.addEventListener('scroll', () => {
            $jump.style.display = isAtBottom() ? 'none' : 'inline-flex';
        });
        $jump.addEventListener('click', scrollToBottom);

        function appendSystem(text){
            const el = document.createElement('div');
            el.className = 'status';
            el.textContent = text;
            $msgs.appendChild(el);
            // không auto scroll ở đây
        }

        function append(msg){
            const stick = isAtBottom(); // chỉ auto scroll nếu đang ở đáy
            const me = (msg.senderId === window.CURRENT_USER_ID);
            const el = document.createElement('div');
            el.className = 'msg' + (me ? ' me':'');
            el.innerHTML = `
      <div class="bubble">
        <div>${escapeHtml(msg.content||'')}</div>
        <small>${timeHHmm(msg.sentAt)}</small>
      </div>`;
            $msgs.appendChild(el);
            if(stick) scrollToBottom();
        }

        function enableEditor(enabled){
            $send.disabled = !enabled;
            $input.disabled = !enabled;
        }

        async function loadConversations(){
            try{
                const res = await fetch('/api/chat/manager/conversations');
                if(!res.ok){
                    $list.innerHTML = `<div class="text-center text-secondary py-3">Không tải được (HTTP ${res.status})</div>`;
                    return;
                }
                const data = await res.json();
                if(!Array.isArray(data) || data.length === 0){
                    $list.innerHTML = `<div class="text-center text-secondary py-3">Chưa có hội thoại nào</div>`;
                    return;
                }
                $list.innerHTML = '';
                data.forEach(c=>{
                    const el = document.createElement('div');
                    el.className = 'conv-item' + (c.unread ? ' unread' : '');
                    el.dataset.id = c.id;

                    const name = c.customerName || ('KH-' + c.customerId);
                    const snippet = c.lastSnippet || '';
                    const when = c.lastMessageAt ? timeHHmm(c.lastMessageAt) : '';
                    const badge = c.unreadCount > 0 ? `<span class="unread-badge">${c.unreadCount}</span>` : '';

                    el.innerHTML = `
          <div class="avatar">${initials(name)}</div>
          <div class="d-flex flex-column" style="flex:1; min-width:0;">
            <div class="d-flex align-items-center gap-2">
              <span class="conv-name">${escapeHtml(name)}</span>
              ${badge}
            </div>
            <div class="conv-snippet">${escapeHtml(snippet)}</div>
          </div>
          <div class="conv-time">${when}</div>
        `;
                    el.onclick = ()=> openConversation(c);
                    $list.appendChild(el);
                });
            } catch (e){
                console.error(e);
                $list.innerHTML = `<div class="text-center text-secondary py-3">Lỗi khi tải hội thoại</div>`;
            }
        }

        async function openConversation(c){
            // active item
            Array.from($list.children).forEach(i=> i.classList.remove('active'));
            const current = Array.from($list.children).find(i=> i.dataset.id==c.id);
            if(current) current.classList.add('active');

            conversationId = c.id;
            const name = c.customerName || ('KH-' + c.customerId);
            $title.textContent = `Chat với ${name}`;
            $msgs.innerHTML = '';
            enableEditor(true);

            // load history
            try{
                const hx = await fetch(`/api/chat/history?conversationId=${conversationId}`);
                const list = await hx.json();
                (list||[]).forEach(append);
                // đảm bảo xuống đáy sau khi render lịch sử
                scrollToBottom();
                
                // Đánh dấu đã đọc khi mở conversation
                await markConversationAsRead(conversationId);
                
                // Xóa badge unread trên UI ngay lập tức
                if(current){
                    current.classList.remove('unread');
                    const badge = current.querySelector('.unread-badge');
                    if(badge) badge.remove();
                }
            } catch(e){
                console.error(e);
                appendSystem('Không tải được lịch sử hội thoại.');
            }

            // subscribe topic
            if(convSub){ convSub.unsubscribe(); convSub = null; }
            if(stomp && connected){
                convSub = stomp.subscribe(`/topic/conversation.${conversationId}`, frame=>{
                    try{
                        const msg = JSON.parse(frame.body);
                        append(msg);
                        
                        // Nếu tin nhắn từ khách hàng và đang xem conversation này, mark as read ngay
                        if(msg.senderId !== window.CURRENT_USER_ID){
                            markConversationAsRead(conversationId);
                        }
                    }catch(e){ console.error('Parse WS message error', e); }
                });
            }
        }

        function connect(){
            const sock = new SockJS('/ws');
            stomp = Stomp.over(sock);
            // stomp.debug = null;

            stomp.connect({}, async ()=>{
                connected = true;
                setState('Đã kết nối');
                await loadConversations();
                $send.onclick = send;
                $input.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });
                
                // Subscribe to all manager's conversations for notifications
                subscribeGlobalNotifications();
            }, err=>{
                connected = false;
                console.error('STOMP error', err);
                setState('Mất kết nối');
                appendSystem('Không thể kết nối realtime. Tin nhắn sẽ không gửi/nhận được.');
                enableEditor(false);
            });
        }

        function send(){
            const text = $input.value.trim();
            if(!text || !stomp || !connected || !conversationId) return;
            stomp.send('/app/chat.send', {}, JSON.stringify({ conversationId, content: text }));
            $input.value = '';
            $input.focus();
        }
        
        async function markConversationAsRead(convId){
            try{
                await fetch('/api/chat/mark-read?conversationId=' + convId, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
            }catch(e){
                console.log('Cannot mark as read:', e);
            }
        }
        
        function subscribeGlobalNotifications(){
            // Subscribe to a topic that broadcasts new messages to all manager conversations
            // We'll subscribe to each conversation's topic individually
            if(globalSub){ globalSub.unsubscribe(); globalSub = null; }
            
            // Alternative: poll for new conversations every 30s
            let lastUnreadCount = 0;
            setInterval(async () => {
                const oldConvIds = Array.from($list.children).map(el => el.dataset.id);
                await loadConversations();
                const newConvIds = Array.from($list.children).map(el => el.dataset.id);
                
                // Check if there are new conversations or new unread messages
                const added = newConvIds.filter(id => !oldConvIds.includes(id));
                
                // Count current unread
                const currentUnread = Array.from($list.children).filter(el => el.classList.contains('unread')).length;
                
                // Notify if new conversations or more unread messages
                if(added.length > 0 || (currentUnread > lastUnreadCount && lastUnreadCount >= 0)){
                    playNotification();
                    showBrowserNotification('Tin nhắn mới từ khách hàng!', 'Bạn có tin nhắn mới cần xem');
                }
                
                lastUnreadCount = currentUnread;
            }, 30000);
        }
        
        function playNotification(){
            try{
                $audio.currentTime = 0;
                $audio.play().catch(e => console.log('Cannot play audio:', e));
            }catch(e){}
        }
        
        function showBrowserNotification(title, body){
            if(!('Notification' in window)) return;
            
            if(Notification.permission === 'granted'){
                new Notification(title, {
                    body: body,
                    icon: '/images/logo.png',
                    badge: '/images/logo.png',
                    tag: 'chat-notification',
                    requireInteraction: false
                });
            } else if(Notification.permission !== 'denied'){
                Notification.requestPermission().then(permission => {
                    if(permission === 'granted'){
                        new Notification(title, {body: body, icon: '/images/logo.png'});
                    }
                });
            }
        }

        connect();
        
        // Request notification permission on load
        if('Notification' in window && Notification.permission === 'default'){
            setTimeout(() => {
                Notification.requestPermission();
            }, 2000);
        }
    })();
</script>
</body>
</html>
