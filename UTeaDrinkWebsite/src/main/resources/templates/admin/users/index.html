<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/admin-layout :: adminLayout(~{::title}, ~{::content})}">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>
<div th:fragment="content">

  <div th:replace="~{fragments/breadcrumbs ::
    bc('Trang ch·ªß', @{/admin/home}, null, null, 'Ng∆∞·ªùi d√πng')}"></div>

  <div class="container-fluid p-0">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>
      <a class="btn btn-primary" th:href="@{/admin/users/new}"><i class="bi bi-plus-circle"></i>Th√™m ng∆∞·ªùi d√πng</a>
    </div>

    <!-- Alerts -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Search -->
    <form class="row g-2 mb-3" method="get" th:action="@{/admin/users}">
      <div class="col-auto">
        <input class="form-control" name="kw" th:value="${kw}" placeholder="T√¨m theo email / t√™n">
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-secondary">T√¨m ki·∫øm</button>
      </div>
    </form>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>Username</th>
          <th>H·ªç t√™n</th>
          <th>Tr·∫°ng th√°i</th>
          <th>Vai tr√≤</th>
          <th style="width: 240px">Thao t√°c</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="u : ${page.content}">
          <td th:text="${u.id}"></td>
          <td th:text="${u.email}"></td>
          <td th:text="${u.username}"></td>
          <td th:text="${u.fullName}"></td>

          <td>
            <span th:classappend="${u.status=='ACTIVE'} ? 'badge bg-success'
                                : (${u.status=='LOCKED'} ? 'badge bg-danger' : 'badge bg-secondary')"
                  th:text="${u.status}"></span>
          </td>

          <td>
            <span th:each="r : ${u.roles != null ? u.roles : {}}"
                  th:text="${#strings.toUpperCase(r.code)}"
                  th:class="${'badge badge-role me-1 ' +
                    (#strings.equalsIgnoreCase(r.code,'ADMIN')   ? 'role-admin'   :
                     #strings.equalsIgnoreCase(r.code,'MANAGER') ? 'role-manager' :
                     #strings.equalsIgnoreCase(r.code,'SELLER')  ? 'role-seller'  :
                     #strings.equalsIgnoreCase(r.code,'SHIPPER') ? 'role-shipper' :
                     'role-customer')}">
            </span>
          </td>

          <td>
            <!-- S·ª≠a: chuy·ªÉn sang trang edit -->
            <a class="btn btn-sm btn-outline-primary me-1"
               th:href="@{'/admin/users/' + ${u.id} + '/edit'}">S·ª≠a</a>

            <!-- Kh√≥a/M·ªü -->
            <form th:if="${u.status=='ACTIVE'}" class="d-inline" method="post"
                  th:action="@{'/admin/users/' + ${u.id} + '/lock'}">
              <button class="btn btn-sm btn-outline-warning">Kh√≥a</button>
            </form>
            <form th:if="${u.status=='LOCKED'}" class="d-inline" method="post"
                  th:action="@{'/admin/users/' + ${u.id} + '/unlock'}">
              <button class="btn btn-sm btn-outline-success">M·ªü</button>
            </form>

            <!-- Reset MK: gi·ªØ modal (ho·∫∑c t√°ch trang ri√™ng sau) -->
            <button class="btn btn-sm btn-outline-secondary ms-1"
                    data-bs-toggle="modal" data-bs-target="#resetModal"
                    th:attr="data-id=${u.id},data-email=${u.email}">Reset MK</button>

            <!-- X√≥a -->
            <form class="d-inline ms-1" method="post"
                  th:action="@{'/admin/users/' + ${u.id} + '/delete'}"
                  onsubmit="return confirm('X√≥a ng∆∞·ªùi d√πng n√†y?');">
              <button class="btn btn-sm btn-outline-danger">X√≥a</button>
            </form>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mt-3">

      <!-- Pagination -->
      <nav th:if="${page.totalPages > 1}" aria-label="Page navigation">
        <ul class="pagination mb-0">
          <!-- Prev -->
          <li class="page-item" th:classappend="${pageIndex == 1} ? 'disabled'">
            <a class="page-link"
              th:href="@{/admin/users(page=${pageIndex-1}, size=${size}, kw=${kw})}">¬´</a>
          </li>

          <!-- Numbers -->
          <li class="page-item"
              th:each="i : ${#numbers.sequence(1, page.totalPages)}"
              th:classappend="${i == pageIndex} ? 'active'">
            <a class="page-link"
              th:text="${i}"
              th:href="@{/admin/users(page=${i}, size=${size}, kw=${kw})}"></a>
          </li>

          <!-- Next -->
          <li class="page-item" th:classappend="${pageIndex == page.totalPages} ? 'disabled'">
            <a class="page-link"
              th:href="@{/admin/users(page=${pageIndex+1}, size=${size}, kw=${kw})}">¬ª</a>
          </li>
        </ul>
      </nav>

      <!-- Page size selector -->
      <form th:action="@{/admin/users}" method="get" class="d-flex align-items-center gap-2">
        <input type="hidden" name="kw"   th:value="${kw}">
        <input type="hidden" name="page" value="1">

        <label for="userPageSize" class="form-label mb-0 text-nowrap">S·ªë d√≤ng/trang:</label>
        <select id="userPageSize" class="form-select form-select-sm" name="size"
                style="width:auto" onchange="this.form.submit()">
          <option th:each="s : ${sizes}" th:value="${s}" th:text="${s}" th:selected="${s == size}"></option>
        </select>
      </form>

    </div>

  <!-- (CH·ªà GI·ªÆ) Reset Password Modal -->
  <div class="modal fade" id="resetModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" method="post">
        <div class="modal-header">
          <h5 class="modal-title">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="reset-id">
          <div class="mb-2">
            <label class="modal-label">Email</label>
            <input class="form-control" id="reset-email" disabled>
          </div>
          <div class="mb-2">
            <label class="modal-label">M·∫≠t kh·∫©u m·ªõi</label>
            <input class="form-control" name="newPassword" id="reset-pass" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">H·ªßy</button>
          <button class="btn btn-primary">X√°c nh·∫≠n</button>
        </div>
      </form>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ch·ªâ c√≤n JS cho reset password
  const resetModal = document.getElementById('resetModal');
  resetModal.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget;
    const id = btn.getAttribute('data-id');
    const email = btn.getAttribute('data-email');
    document.getElementById('reset-id').value = id;
    document.getElementById('reset-email').value = email;
    this.querySelector('form').setAttribute('action', '/admin/users/' + id + '/reset-password');
  });
</script>
</body>
</html>
