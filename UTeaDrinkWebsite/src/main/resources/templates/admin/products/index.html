<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{fragments/admin-layout :: adminLayout(~{::title}, ~{::content})}">
<head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω s·∫£n ph·∫©m</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet" />
</head>
<body>

<!-- Header d√πng fragment -->
<div th:fragment="content">

<div th:replace="~{fragments/breadcrumbs ::
  bc('Trang ch·ªß', @{/admin/home},
     null, null,
     'S·∫£n ph·∫©m')
}"></div>


    <div class="container-fluid p-0">
 
        <h3 class="mb-3">üßã Qu·∫£n l√Ω s·∫£n ph·∫©m</h3>

        <!-- B·ªô l·ªçc -->
        <form id="filterForm" class="row g-2 align-items-end mb-3"
              method="get" th:action="@{/admin/products}">
            <div class="col-md-3">
                <label class="form-label">T·ª´ kh√≥a</label> <input
                    class="form-control" name="q" th:value="${q}"
                    placeholder="T√™n s·∫£n ph·∫©m..." />
            </div>

            <div class="col-md-3">
                <label class="form-label">C·ª≠a h√†ng</label> <select
                    class="form-select" name="shopId">
                <option value="" th:selected="${shopId==null}">-- T·∫•t c·∫£
                    --</option>
                <option th:each="s : ${shops}" th:value="${s.id}"
                        th:text="${s.name}"
                        th:selected="${shopId!=null and s.id == shopId}"></option>
            </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Tr·∫°ng th√°i</label> <select
                    class="form-select" name="status">
                <option th:value="'ALL'" th:selected="${status=='ALL'}">T·∫•t
                    c·∫£</option>
                <option th:value="'AVAILABLE'" th:selected="${status=='AVAILABLE'}">ƒêang
                    b√°n</option>
                <option th:value="'HIDDEN'" th:selected="${status=='HIDDEN'}">ƒê√£
                    ·∫©n</option>
                <option th:value="'OUT_OF_STOCK'"
                        th:selected="${status=='OUT_OF_STOCK'}">H·∫øt h√†ng</option>
            </select>
            </div>

            <!-- K√≠ch th∆∞·ªõc trang -->
            <div class="col-md-2">
                <label class="form-label">S·ªë d√≤ng/trang</label> <select
                    id="sizeSelect" class="form-select" name="size">
                <option th:each="s : ${sizes}" th:value="${s}" th:text="${s}"
                        th:selected="${s == size}"></option>
                <option value="custom"
                        th:selected="${!(#lists.contains(sizes, size))}">T√πy
                    ch·ªânh‚Ä¶</option>
            </select>
            </div>

            <!-- Nh·∫≠p size t√πy ch·ªânh -->
            <div id="customSizeWrap" class="col-md-2"
                 th:classappend="${#lists.contains(sizes, size)} ? 'd-none' : ''">
                <label class="form-label">Nh·∫≠p s·ªë</label> <input id="customSize"
                                                                 type="number" min="1" max="200" class="form-control"
                                                                 th:value="${size}">
            </div>

            <div class="col-md-12 d-flex gap-2 mt-2">
                <!-- Khi l·ªçc, v·ªÅ trang 1 -->
                <input type="hidden" name="page" value="1">
                <button class="btn btn-primary">L·ªçc</button>
                <a class="btn btn-outline-secondary"
                   th:href="@{/admin/products(size=${size})}">Reset</a>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div></div>
                <a class="btn btn-success"
                   th:href="@{/admin/products/new(
      q=${q}, shopId=${shopId}, status=${status}, page=${pageIndex}, size=${size}
  )}">+
                    Th√™m s·∫£n ph·∫©m</a>
            </div>

        </form>


        <!-- B·∫£ng d·ªØ li·ªáu -->
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                <tr>
                    <th>#</th>
                    <th>·∫¢nh</th>
                    <th>T√™n</th>
                    <th>Gi√° g·ªëc</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Shop</th>
                    <th class="text-end">Thao t√°c</th>
                </tr>
                </thead>
                <tbody>
                <tr
                        th:if="${page == null or page.content == null or #lists.isEmpty(page.content)}">
                    <td colspan="7" class="text-center text-muted">Kh√¥ng c√≥ s·∫£n
                        ph·∫©m.</td>
                </tr>

                <tr th:each="p, iStat : ${page.content}">
                    <td th:text="${iStat.index + 1 + (pageIndex - 1) * size}"></td>

                    <td><img
                            th:src="${(#lists.isEmpty(p.images)
   ? 'https://res.cloudinary.com/dhmh2ekqy/image/upload/w_96,h_96,c_fill,f_auto,q_auto/placeholder/no-image.png'
   : p.images.get(0).url)}"
                            alt="img"
                            style="width: 64px; height: 64px; object-fit: cover; border-radius: 8px;">

                    </td>

                    <td th:text="${p.name}"></td>

                    <td
                            th:text="${#numbers.formatDecimal(p.basePrice, 0, 'COMMA', 2, 'POINT')}"></td>

                    <td><span class="badge bg-success"
                              th:if="${p.status=='AVAILABLE'}">AVAILABLE</span> <span
                            class="badge bg-secondary" th:if="${p.status=='HIDDEN'}">HIDDEN</span>
                        <span class="badge bg-warning text-dark"
                              th:if="${p.status=='OUT_OF_STOCK'}">OUT OF STOCK</span></td>

                    <!-- tr√°nh lazy-load l·ªói: ch·ªâ hi·ªÉn th·ªã t√™n n·∫øu shop != null -->
                    <td th:text="${p.shop != null ? p.shop.name : 'N/A'}"></td>

                    <td class="text-end"><a class="btn btn-sm btn-outline-primary"
                                            th:href="@{/admin/products/{id}/edit(
               id=${p.id},
               q=${q}, shopId=${shopId}, status=${status},
               page=${pageIndex}, size=${size}
            )}">
                        S·ª≠a
                    </a>
                        <!-- ·∫®n/M·ªü -->
                        <form th:if="${p.status != 'HIDDEN'}" th:action="@{|/admin/products/${p.id}/hide|}" method="post"
                              class="d-inline">
                            <input th:if="${_csrf != null}" type="hidden"
                                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <input type="hidden" name="q" th:value="${q}"> <input
                                type="hidden" name="shopId" th:value="${shopId}"> <input
                                type="hidden" name="status" th:value="${status}"> <input
                                type="hidden" name="page" th:value="${pageIndex}"> <input
                                type="hidden" name="size" th:value="${size}">
                            <button class="btn btn-sm btn-outline-warning">·∫®n</button>
                        </form>

                        <form th:if="${p.status=='HIDDEN'}"
                              th:action="@{|/admin/products/${p.id}/unhide|}" method="post"
                              class="d-inline">
                            <input th:if="${_csrf != null}" type="hidden"
                                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <input type="hidden" name="q" th:value="${q}"> <input
                                type="hidden" name="shopId" th:value="${shopId}"> <input
                                type="hidden" name="status" th:value="${status}"> <input
                                type="hidden" name="page" th:value="${pageIndex}"> <input
                                type="hidden" name="size" th:value="${size}">
                            <button class="btn btn-sm btn-outline-success">M·ªü</button>
                        </form> <!-- X√≥a h·∫≥n -->
                        <form th:action="@{|/admin/products/${p.id}/delete-hard|}"
                              method="post" class="d-inline"
                              onsubmit="return confirm('X√≥a H·∫≤N s·∫£n ph·∫©m kh·ªèi h·ªá th·ªëng?');">
                            <input th:if="${_csrf != null}" type="hidden"
                                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <input type="hidden" name="q" th:value="${q}"> <input
                                type="hidden" name="shopId" th:value="${shopId}"> <input
                                type="hidden" name="status" th:value="${status}"> <input
                                type="hidden" name="page" th:value="${pageIndex}"> <input
                                type="hidden" name="size" th:value="${size}">
                            <button class="btn btn-sm btn-danger">X√≥a</button>
                        </form></td>
                </tr>
                </tbody>
            </table>
        </div>

        <nav th:if="${page.totalPages > 1}">
            <ul class="pagination">
                <!-- Prev -->
                <li class="page-item" th:classappend="${pageIndex == 1}? 'disabled'">
                    <a class="page-link"
                       th:href="@{/admin/products(
                    page=${pageIndex-1},
                    size=${size},
                    status=${status},
                    q=${q},
                    shopId=${shopId}
                  )}">¬´</a>
                </li>

                <!-- S·ªë trang (1-based) -->
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(1, page.totalPages)}"
                    th:classappend="${i == pageIndex}? 'active'"><a
                        class="page-link" th:text="${i}"
                        th:href="@{/admin/products(
                    page=${i},
                    size=${size},
                    status=${status},
                    q=${q},
                    shopId=${shopId}
                  )}"></a>
                </li>

                <!-- Next -->
                <li class="page-item"
                    th:classappend="${pageIndex == page.totalPages}? 'disabled'">
                    <a class="page-link"
                       th:href="@{/admin/products(
                    page=${pageIndex+1},
                    size=${size},
                    status=${status},
                    q=${q},
                    shopId=${shopId}
                  )}">¬ª</a>
                </li>
            </ul>

            <!-- ƒêi t·ªõi trang -->
            <form class="d-flex align-items-center gap-2" method="get"
                  th:action="@{/admin/products}">
                <input type="hidden" name="q" th:value="${q}"> <input
                    type="hidden" name="shopId" th:value="${shopId}"> <input
                    type="hidden" name="status" th:value="${status}"> <input
                    type="hidden" name="size" th:value="${size}"> <label
                    class="form-label m-0">T·ªõi trang:</label> <input name="page"
                                                                     type="number" class="form-control" style="width: 100px" min="1"
                                                                     th:attr="max=${page.totalPages}" th:value="${pageIndex}">
                <button class="btn btn-outline-primary">Go</button>
            </form>
        </nav>
    </div>
</div>
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        const form = document.getElementById('filterForm');
        const sizeSelect = document.getElementById('sizeSelect');
        const wrap = document.getElementById('customSizeWrap');
        const custom = document.getElementById('customSize');

        // ƒë·ªïi preset
        sizeSelect?.addEventListener('change', () => {
            if (sizeSelect.value === 'custom') {
                wrap.classList.remove('d-none');
                custom.focus();
            } else {
                wrap.classList.add('d-none');
                custom.value = '';
                form.querySelector('input[name="page"]').value = 1; // v·ªÅ trang 1
                form.submit();
            }
        });

        // tr∆∞·ªõc khi submit: n·∫øu custom -> ch·ªâ g·ª≠i 1 tham s·ªë size (s·ªë)
        form?.addEventListener('submit', (e) => {
            if (sizeSelect.value === 'custom') {
                const val = parseInt(custom.value, 10);
                if (!val || val < 1) {
                    e.preventDefault();
                    custom.focus();
                    return;
                }
                const bounded = Math.min(Math.max(val, 1), 200);

                // kh√¥ng g·ª≠i size=custom
                sizeSelect.disabled = true;

                // g·∫Øn size (s·ªë) b·∫±ng input ·∫©n
                let hidden = form.querySelector('input[name="size"][data-generated="1"]');
                if (!hidden) {
                    hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = 'size';
                    hidden.setAttribute('data-generated', '1');
                    form.appendChild(hidden);
                }
                hidden.value = String(bounded);

                // v·ªÅ trang 1 khi ƒë·ªïi size
                form.querySelector('input[name="page"]').value = 1;
            }
        });
    })();
</script>
</body>
</html>
