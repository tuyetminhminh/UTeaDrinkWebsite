<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{fragments/admin-layout :: adminLayout(~{::title}, ~{::content})}">
<head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω s·∫£n ph·∫©m</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet" />
</head>
<body>

<!-- Header d√πng fragment -->
<div th:fragment="content">

<div th:replace="~{fragments/breadcrumbs ::
  bc('Trang ch·ªß', @{/admin/home},
     null, null,
     'S·∫£n ph·∫©m')
}"></div>


    <div class="container-fluid p-0">
 
        
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="mb-3">üßã Qu·∫£n l√Ω s·∫£n ph·∫©m</h3>
            <a class="btn btn-success" th:href="@{/admin/products/new(
                q=${q}, shopId=${shopId}, status=${status},
                page=${pageIndex}, size=${size})}">+Th√™m s·∫£n ph·∫©m</a>
        </div>
        <!-- B·ªô l·ªçc -->
        <form id="filterForm" class="row g-2 align-items-end mb-3"
            method="get" th:action="@{/admin/products}">
            <div class="col-lg-3 col-md-6">
                <label class="form-label">T·ª´ kh√≥a</label>
                <input class="form-control" name="q" th:value="${q}" placeholder="T√™n s·∫£n ph·∫©m..." />
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label">C·ª≠a h√†ng</label>
                <select class="form-select" name="shopId">
                    <option value="">-- T·∫•t c·∫£ --</option>
                    <option th:each="s : ${shops}" th:value="${s.id}" th:text="${s.name}"
                            th:selected="${shopId != null and s.id == shopId}"></option>
                </select>
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label">Tr·∫°ng th√°i</label>
                <select class="form-select" name="status">
                    </select>
            </div>
            
            <div class="col-lg-auto d-flex gap-2">
                <input type="hidden" name="page" value="1">
                <button class="btn btn-primary">L·ªçc</button>
                <a class="btn btn-outline-secondary" th:href="@{/admin/products(size=${size})}">Reset</a>
            </div>
            

        </form>


        <!-- B·∫£ng d·ªØ li·ªáu -->
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                <tr>
                    <th>#</th>
                    <th>·∫¢nh</th>
                    <th>T√™n</th>
                    <th>Gi√° g·ªëc</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Shop</th>
                    <th class="text-end">Thao t√°c</th>
                </tr>
                </thead>
                <tbody>
                <tr
                        th:if="${page == null or page.content == null or #lists.isEmpty(page.content)}">
                    <td colspan="7" class="text-center text-muted">Kh√¥ng c√≥ s·∫£n
                        ph·∫©m.</td>
                </tr>

                <tr th:each="p, iStat : ${page.content}">
                    <td th:text="${iStat.index + 1 + (pageIndex - 1) * size}"></td>

                    <td><img
                            th:src="${(#lists.isEmpty(p.images)
   ? 'https://res.cloudinary.com/dhmh2ekqy/image/upload/w_96,h_96,c_fill,f_auto,q_auto/placeholder/no-image.png'
   : p.images.get(0).url)}"
                            alt="img"
                            style="width: 64px; height: 64px; object-fit: cover; border-radius: 8px;">

                    </td>

                    <td th:text="${p.name}"></td>

                    <td
                            th:text="${#numbers.formatDecimal(p.basePrice, 0, 'COMMA', 2, 'POINT')}"></td>

                    <td><span class="badge bg-success"
                              th:if="${p.status=='AVAILABLE'}">AVAILABLE</span> <span
                            class="badge bg-secondary" th:if="${p.status=='HIDDEN'}">HIDDEN</span>
                        <span class="badge bg-warning text-dark"
                              th:if="${p.status=='OUT_OF_STOCK'}">OUT OF STOCK</span></td>

                    <!-- tr√°nh lazy-load l·ªói: ch·ªâ hi·ªÉn th·ªã t√™n n·∫øu shop != null -->
                    <td th:text="${p.shop != null ? p.shop.name : 'N/A'}"></td>

                    <td class="text-end"><a class="btn btn-sm btn-outline-primary"
                                            th:href="@{/admin/products/{id}/edit(
               id=${p.id},
               q=${q}, shopId=${shopId}, status=${status},
               page=${pageIndex}, size=${size}
            )}">
                        S·ª≠a
                    </a>
                        <!-- ·∫®n/M·ªü -->
                        <form th:if="${p.status != 'HIDDEN'}" th:action="@{|/admin/products/${p.id}/hide|}" method="post"
                            class="d-inline">
                            
                            <button class="btn btn-sm btn-outline-warning">·∫®n</button>
                        </form>

                        <form th:if="${p.status=='HIDDEN'}"
                            th:action="@{|/admin/products/${p.id}/unhide|}" method="post"
                            class="d-inline">
                            
                            <button class="btn btn-sm btn-outline-success">M·ªü</button>
                        </form> <!-- X√≥a h·∫≥n -->
                        <form th:action="@{|/admin/products/${p.id}/delete-hard|}"
                            method="post" class="d-inline"
                            onsubmit="return confirm('X√≥a H·∫≤N s·∫£n ph·∫©m kh·ªèi h·ªá th·ªëng?');">
                            
                            <button class="btn btn-sm btn-danger">X√≥a</button>
                        </form></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Ph√¢n trang -->
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mt-4">

            <nav th:if="${page.totalPages > 1}" aria-label="Page navigation">
                <ul class="pagination mb-0">
                    <li class="page-item" th:classappend="${pageIndex == 1}? 'disabled'">
                        <a class="page-link" th:href="@{/admin/products(page=${pageIndex-1}, size=${size}, status=${status}, q=${q}, shopId=${shopId})}">¬´</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(1, page.totalPages)}" th:classappend="${i == pageIndex}? 'active'">
                        <a class="page-link" th:text="${i}" th:href="@{/admin/products(page=${i}, size=${size}, status=${status}, q=${q}, shopId=${shopId})}"></a>
                    </li>
                    <li class="page-item" th:classappend="${pageIndex == page.totalPages}? 'disabled'">
                        <a class="page-link" th:href="@{/admin/products(page=${pageIndex+1}, size=${size}, status=${status}, q=${q}, shopId=${shopId})}">¬ª</a>
                    </li>
                </ul>
            </nav>
            <div th:unless="${page.totalPages > 1}"></div> 

            <form th:action="@{/admin/products}" method="get" class="d-flex align-items-center gap-2">
                <input type="hidden" name="q" th:value="${q}">
                <input type="hidden" name="shopId" th:value="${shopId}">
                <input type="hidden" name="status" th:value="${status}">
                <input type="hidden" name="page" value="1">

                <label for="pageSizeSelector" class="form-label mb-0 text-nowrap">S·ªë d√≤ng/trang:</label>
                <select id="pageSizeSelector"
                        class="form-select form-select-sm"
                        name="size"
                        style="width:auto"
                        onchange="this.form.submit()">
                    <option th:each="s : ${sizes}"
                            th:value="${s}"
                            th:text="${s}"
                            th:selected="${s == size}">
                    </option>
                </select>
            </form>

        </div>

    </div>
</div>
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const pageSizeSelector = document.getElementById('pageSizeSelector');
        if (pageSizeSelector) {
            pageSizeSelector.addEventListener('change', function() {
                // T·ª± ƒë·ªông submit form ch·ª©a n√≥ khi gi√° tr·ªã thay ƒë·ªïi
                this.form.submit();
            });
        }
    });
</script>
</body>
</html>
