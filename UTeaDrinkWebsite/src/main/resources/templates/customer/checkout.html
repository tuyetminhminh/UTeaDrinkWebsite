<!-- templates/customer/checkout.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title>Thanh toán</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Bootstrap & Icons (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <!-- Font đẹp, hỗ trợ TV -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

    <style>
        :root{--bg:#f6f7f9;--panel:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e9edf1;--radius:16px}
        body{background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial}
        .wrap{max-width:1180px;margin:28px auto;padding:0 12px}
        .panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 6px 16px rgba(15,23,42,.05)}
        .section{padding:18px}
        .section-title{font-weight:900;font-size:18px;margin-bottom:12px}
        .back-link{display:inline-flex;align-items:center;gap:8px;font-weight:800;text-decoration:none;color:var(--ink)}
        .back-link:hover{opacity:.85}

        /* input full chiều ngang, gọn chiều cao */
        .form-label{font-weight:700}
        .form-control{height:44px;border-radius:14px}

        /* nút “chip” mở modal */
        .btn-chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #dfe3e8;border-radius:999px;padding:8px 14px;background:#fff;font-weight:800}
        .btn-chip:hover{background:#f8f9fb}

        /* radio payment tiles */
        .pay-tile{display:flex;align-items:center;gap:12px;border:1px solid var(--line);border-radius:14px;padding:12px}
        .pay-tile + .pay-tile{margin-top:10px}
        .pay-logo{width:40px;height:40px;border-radius:10px;overflow:hidden;background:#f1f5f9;display:flex;align-items:center;justify-content:center}
        .pay-logo img{width:100%;height:100%;object-fit:contain}

        /* chips coupon đã chọn */
        .chip{display:inline-flex;align-items:center;gap:8px;border:1px dashed #ced2d8;border-radius:999px;padding:6px 10px;background:#fff}
        .chip .x{cursor:pointer;font-weight:700}

        .summary{position:sticky;top:16px}
        @media (max-width:992px){.summary{position:static}}
        .row-line{display:flex;justify-content:space-between;padding:8px 0}
        .total{display:flex;justify-content:space-between;border-top:1px solid var(--line);margin-top:8px;padding-top:14px}
        .total .price{font-size:20px;font-weight:900}
        .btn-order{height:48px;border-radius:14px;font-weight:900;padding:0 22px}
    </style>
</head>
<body>
    <div th:replace="~{fragments/header-customer :: customerHeader}"></div>
<div class="container mt-3" th:if="${toastSuccess}">
    <div class="alert alert-success" th:text="${toastSuccess}"></div>
</div>
<div class="container mt-3" th:if="${toastError}">
    <div class="alert alert-danger" th:text="${toastError}"></div>
</div>

<div class="wrap">
    <a class="back-link mb-3" th:href="@{/customer/cart}">
        <i class="bi bi-arrow-left"></i> Quay lại giỏ hàng
    </a>

    <!-- FORM CHÍNH -->
    <form th:action="@{/customer/checkout}" method="post" th:object="${req}">
        <div class="row g-3">
            <!-- LEFT -->
            <div class="col-lg-8">
                <!-- ĐỊA CHỈ -->
                <div class="panel section">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="section-title mb-0">Thông tin giao hàng</div>
                        <button class="btn-chip" type="button" data-bs-toggle="modal" data-bs-target="#addressModal">
                            <i class="bi bi-geo-alt"></i> Chọn địa chỉ đã lưu
                        </button>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-12">
                            <label class="form-label">Họ tên</label>
                            <input class="form-control" th:field="*{fullname}" placeholder="VD: Nguyễn Văn A">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Số điện thoại</label>
                            <input class="form-control" th:field="*{phone}" inputmode="tel" placeholder="VD: 09xx xxx xxx">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Địa chỉ</label>
                            <input class="form-control" th:field="*{addressLine}" placeholder="Số nhà, đường">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Quận/Huyện</label>
                            <input class="form-control" th:field="*{district}" placeholder="VD: Quận 1">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Tỉnh/Thành</label>
                            <input class="form-control" th:field="*{province}" placeholder="VD: TP. HCM">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Ghi chú (tuỳ chọn)</label>
                            <input class="form-control" th:field="*{note}" placeholder="Ghi chú cho shipper">
                        </div>
                    </div>
                </div>

                <!-- THANH TOÁN -->
                <div class="panel section mt-3">
                    <div class="section-title">Hình thức thanh toán</div>

                    <label class="pay-tile">
                        <input class="form-check-input me-2" type="radio" th:field="*{paymentMethod}" value="COD">
                        <span class="pay-logo d-none d-md-flex"><i class="bi bi-cash-coin"></i></span>
                        <div>
                            <div class="fw-bold">Thanh toán khi nhận hàng (COD)</div>
                            <div class="text-muted small">Nhận hàng rồi thanh toán cho shipper.</div>
                        </div>
                    </label>

                    <label class="pay-tile">
                        <input class="form-check-input me-2" type="radio" th:field="*{paymentMethod}" value="MOMO">
                        <span class="pay-logo"><img th:src="@{/img/momo.png}" alt="MoMo"></span>
                        <div>
                            <div class="fw-bold">Ví MoMo (QR)</div>
                            <div class="text-muted small">Quét mã QR để thanh toán.</div>
                        </div>
                    </label>

                    <label class="pay-tile">
                        <input class="form-check-input me-2" type="radio" th:field="*{paymentMethod}" value="VNPAY">
                        <span class="pay-logo"><img th:src="@{/img/vnpay.png}" alt="VNPAY"></span>
                        <div>
                            <div class="fw-bold">VNPAY (QR)</div>
                            <div class="text-muted small">Thẻ nội địa/QR VNPAY.</div>
                        </div>
                    </label>

                    <!-- MBBANK PAYMENT OPTION - TEMPORARILY DISABLED -->
                    <!--
                    <label class="pay-tile">
                        <input class="form-check-input me-2" type="radio" th:field="*{paymentMethod}" value="MBBANK">
                        <span class="pay-logo d-none d-md-flex" style="color:#0046ad;font-size:24px">
                            <i class="bi bi-bank2"></i>
                        </span>
                        <div>
                            <div class="fw-bold">MBBank (PayOS)</div>
                            <div class="text-muted small">Thanh toán qua MBBank với mã QR PayOS.</div>
                        </div>
                    </label>
                    -->
                </div>

                <!-- MÃ GIẢM GIÁ & KHUYẾN MÃI -->
                <div class="panel section mt-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="section-title mb-0">Ưu đãi & Giảm giá</div>
                        <button class="btn-chip" type="button" data-bs-toggle="modal" data-bs-target="#couponModal">
                            <i class="bi bi-ticket-perforated"></i> Chọn mã voucher
                        </button>
                    </div>

                    <!-- Voucher đã chọn (có thể xóa) -->
                    <div class="mt-3" th:if="*{couponCode} or *{shipCode}">
                        <div class="small text-muted mb-1">
                            <i class="bi bi-ticket-fill"></i> <strong>Voucher của bạn:</strong>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="chip chip-voucher me-2" th:if="*{couponCode}">
                                <span>Giảm tiền/%:</span><strong th:text="*{couponCode}">CODE</strong>
                                <span class="x" role="button" onclick="removeCoupon('coupon')">×</span>
                            </span>
                            <span class="chip chip-voucher" th:if="*{shipCode}">
                                <span>Giảm ship:</span><strong th:text="*{shipCode}">SHIP</strong>
                                <span class="x" role="button" onclick="removeCoupon('ship')">×</span>
                            </span>
                        </div>
                    </div>

                    <!-- Khuyến mãi tự động (không xóa được) -->
                    <div class="mt-3" th:if="${autoPromoInfo != null and autoPromoInfo.hasAny}">
                        <div class="small text-muted mb-1">
                            <i class="bi bi-gift-fill"></i> <strong>Khuyến mãi tự động:</strong>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-success" th:if="${autoPromoInfo.discountMsg != null}">
                                <i class="bi bi-percent"></i> <span th:text="${autoPromoInfo.discountMsg}">Giảm 20%</span>
                            </span>
                            <span class="badge bg-info" th:if="${autoPromoInfo.freeshipMsg != null}">
                                <i class="bi bi-truck"></i> <span th:text="${autoPromoInfo.freeshipMsg}">Freeship</span>
                            </span>
                        </div>
                    </div>

                    <!-- Hiển thị kết quả áp dụng -->
                    <div class="mt-3" th:if="${summary.couponMessage}">
                        <div class="alert alert-success mb-0 py-2">
                            <i class="bi bi-check-circle-fill"></i>
                            <span th:text="${summary.couponMessage}"></span>
                        </div>
                    </div>

                    <!-- giữ giá trị 2 mã -->
                    <input type="hidden" th:field="*{couponCode}">
                    <input type="hidden" th:field="*{shipCode}">
                </div>
            </div>

            <!-- RIGHT -->
            <div class="col-lg-4">
                <div class="panel section summary">
                    <div class="section-title">Chi tiết thanh toán</div>

                    <div class="row-line">
                        <span class="text-muted">Tạm tính</span>
                        <span th:text="${#numbers.formatDecimal(summary.subtotal,0,'COMMA',0,'POINT')} + 'đ'">0đ</span>
                    </div>
                    <div class="row-line">
                        <span class="text-muted">Phí giao hàng</span>
                        <span th:text="${#numbers.formatDecimal(summary.shippingFee,0,'COMMA',0,'POINT')} + 'đ'">0đ</span>
                    </div>
                    <div class="row-line">
                        <span class="text-muted">Giảm giá</span>
                        <span th:text="${#numbers.formatDecimal(summary.discountAmount,0,'COMMA',0,'POINT')} + 'đ'">0đ</span>
                    </div>
                    <div class="row-line">
                        <span class="text-muted">Giảm phí ship</span>
                        <span th:text="${#numbers.formatDecimal(summary.shipDiscount,0,'COMMA',0,'POINT')} + 'đ'">0đ</span>
                    </div>

                    <!-- nút nằm bên phải, dưới số tiền -->
                    <div class="total">
                        <div class="text-muted">Thành tiền</div>
                        <div class="text-end">
                            <div class="price" th:text="${#numbers.formatDecimal(summary.total,0,'COMMA',0,'POINT')} + 'đ'">0đ</div>
                            <button class="btn btn-dark btn-order mt-2" type="submit">ĐẶT HÀNG</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- ===== MODALS đặt cuối body ===== -->

<!-- Modal ĐỊA CHỈ -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <strong class="modal-title"><i class="bi bi-geo-alt me-1"></i> Sổ địa chỉ</strong>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <button type="button" class="list-group-item list-group-item-action"
                            th:each="a : ${addresses}"
                            th:data-fullname="${a.receiverName}"
                            th:data-phone="${a.phone}"
                            th:data-line="${a.line}"
                            th:data-district="${a.district}"
                            th:data-province="${a.province}"
                            onclick="pickAddress(this)">
                        <div class="d-flex justify-content-between">
                            <div><strong th:text="${a.receiverName}">Tên</strong> <span class="ms-2" th:text="${a.phone}">SĐT</span></div>
                            <span class="badge text-bg-dark" th:if="${a.default}">Mặc định</span>
                        </div>
                        <div class="small text-muted" th:text="${a.line + ', ' + a.district + ', ' + a.province}">...</div>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <a th:href="@{/customer/addresses}" class="btn btn-outline-secondary">Quản lý địa chỉ</a>
                <button class="btn btn-dark" data-bs-dismiss="modal">Dùng địa chỉ đã chọn</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal VOUCHER -->
<div class="modal fade" id="couponModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <strong class="modal-title"><i class="bi bi-ticket-perforated me-1"></i> Chọn mã giảm giá</strong>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-discount" type="button">Giảm tiền/%</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ship" type="button">Miễn/giảm ship</button></li>
                </ul>
                <div class="tab-content p-2">
                    <div class="tab-pane fade show active" id="tab-discount">
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action"
                                    th:each="s : ${suggestionsPair.discountVouchers}"
                                    th:data-code="${s.code}"
                                    onclick="pickCoupon(this,'coupon')">
                                <div class="d-flex justify-content-between">
                                    <strong th:text="${s.title}">CODE</strong>
                                    <span class="text-muted" th:text="${s.note}">...</span>
                                </div>
                                <small class="text-muted" th:text="${s.code}">CODE</small>
                            </button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab-ship">
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action"
                                    th:each="s : ${suggestionsPair.shipVouchers}"
                                    th:data-code="${s.code}"
                                    onclick="pickCoupon(this,'ship')">
                                <div class="d-flex justify-content-between">
                                    <strong th:text="${s.title}">SHIP</strong>
                                    <span class="text-muted" th:text="${s.note}">...</span>
                                </div>
                                <small class="text-muted" th:text="${s.code}">CODE</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <div class="small text-muted">
                        <strong>Đã chọn:</strong>
                        <span id="selectedVoucherInfo" class="text-dark">Chưa chọn mã nào</span>
                    </div>
                </div>
                <!-- giữ lại dữ liệu form khi áp mã -->
                <form th:action="@{/customer/checkout/apply-coupons}" method="post" class="d-flex gap-2" id="applyCouponsForm">
                    <input type="hidden" name="fullname"    th:value="*{fullname}">
                    <input type="hidden" name="phone"       th:value="*{phone}">
                    <input type="hidden" name="addressLine" th:value="*{addressLine}">
                    <input type="hidden" name="district"    th:value="*{district}">
                    <input type="hidden" name="province"    th:value="*{province}">
                    <input type="hidden" name="note"        th:value="*{note}">
                    <input type="hidden" name="paymentMethod" id="hidPaymentMethod" th:value="*{paymentMethod}">
                    <input type="hidden" id="hidCoupon" name="couponCode" th:value="*{couponCode}">
                    <input type="hidden" id="hidShip"   name="shipCode"   th:value="*{shipCode}">
                    <button class="btn btn-dark" type="submit">Áp dụng</button>
                    <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Đóng</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS bundle (bắt buộc để modal hoạt động) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Khi modal mở, sync TOÀN BỘ giá trị từ form chính vào modal
    document.getElementById('couponModal').addEventListener('show.bs.modal', function(){
        const mainForm = document.querySelector('form[action*="checkout"]');
        const applyForm = document.getElementById('applyCouponsForm');
        if(!mainForm || !applyForm) return;

        // ✅ Sync TẤT CẢ dữ liệu từ main form sang apply form
        applyForm.querySelector('[name="fullname"]').value = mainForm.querySelector('[name="fullname"]').value || '';
        applyForm.querySelector('[name="phone"]').value = mainForm.querySelector('[name="phone"]').value || '';
        applyForm.querySelector('[name="addressLine"]').value = mainForm.querySelector('[name="addressLine"]').value || '';
        applyForm.querySelector('[name="district"]').value = mainForm.querySelector('[name="district"]').value || '';
        applyForm.querySelector('[name="province"]').value = mainForm.querySelector('[name="province"]').value || '';
        applyForm.querySelector('[name="note"]').value = mainForm.querySelector('[name="note"]').value || '';
        applyForm.querySelector('[name="paymentMethod"]').value = mainForm.querySelector('[name="paymentMethod"]:checked')?.value || 'COD';

        const currentCoupon = mainForm.querySelector('[name="couponCode"]').value || '';
        const currentShip   = mainForm.querySelector('[name="shipCode"]').value || '';

        document.getElementById('hidCoupon').value = currentCoupon;
        document.getElementById('hidShip').value   = currentShip;

        // Highlight các mã đã chọn
        highlightSelectedVouchers(currentCoupon, currentShip);
    });

    function highlightSelectedVouchers(currentCoupon, currentShip) {
        // Xóa highlight cũ
        document.querySelectorAll('#couponModal .list-group-item').forEach(item => {
            item.classList.remove('active');
        });

        // Highlight mã đang được chọn
        document.querySelectorAll('#couponModal .list-group-item').forEach(item => {
            const code = item.dataset.code || '';
            if ((code === currentCoupon && code) || (code === currentShip && code)) {
                item.classList.add('active');
            }
        });

        // Cập nhật text hiển thị
        updateSelectedVoucherInfo(currentCoupon, currentShip);
    }

    function updateSelectedVoucherInfo(currentCoupon, currentShip) {
        const info = document.getElementById('selectedVoucherInfo');
        if (!info) return;

        const parts = [];
        if (currentCoupon) parts.push('<span class="badge bg-warning text-dark">' + currentCoupon + '</span>');
        if (currentShip) parts.push('<span class="badge bg-info">' + currentShip + '</span>');

        if (parts.length > 0) {
            info.innerHTML = parts.join(' + ');
        } else {
            info.innerHTML = 'Chưa chọn mã nào';
        }
    }

    function pickAddress(btn){
        const f = document.querySelector('form'); if(!f) return;
        f.querySelector('[name="fullname"]').value    = btn.dataset.fullname || '';
        f.querySelector('[name="phone"]').value       = btn.dataset.phone || '';
        f.querySelector('[name="addressLine"]').value = btn.dataset.line || '';
        f.querySelector('[name="district"]').value    = btn.dataset.district || '';
        f.querySelector('[name="province"]').value    = btn.dataset.province || '';
        bootstrap.Modal.getOrCreateInstance(document.getElementById('addressModal')).hide();
    }

    function pickCoupon(btn, kind){
        const code = btn.dataset.code || '';
        if(kind==='coupon') {
            document.getElementById('hidCoupon').value = code;
        }
        if(kind==='ship') {
            document.getElementById('hidShip').value = code;
        }

        // Highlight mã vừa chọn
        const currentCoupon = document.getElementById('hidCoupon').value || '';
        const currentShip   = document.getElementById('hidShip').value || '';
        highlightSelectedVouchers(currentCoupon, currentShip);
    }

    function removeCoupon(kind){
        const mainForm = document.querySelector('form[action*="checkout"]');
        const applyForm = document.getElementById('applyCouponsForm');
        if(!mainForm || !applyForm) return;

        // Sync dữ liệu từ main form sang apply form trước
        applyForm.querySelector('[name="fullname"]').value = mainForm.querySelector('[name="fullname"]').value || '';
        applyForm.querySelector('[name="phone"]').value = mainForm.querySelector('[name="phone"]').value || '';
        applyForm.querySelector('[name="addressLine"]').value = mainForm.querySelector('[name="addressLine"]').value || '';
        applyForm.querySelector('[name="district"]').value = mainForm.querySelector('[name="district"]').value || '';
        applyForm.querySelector('[name="province"]').value = mainForm.querySelector('[name="province"]').value || '';
        applyForm.querySelector('[name="note"]').value = mainForm.querySelector('[name="note"]').value || '';
        applyForm.querySelector('[name="paymentMethod"]').value = mainForm.querySelector('[name="paymentMethod"]:checked')?.value || 'COD';

        // Xóa mã voucher tương ứng
        if(kind==='coupon') {
            document.getElementById('hidCoupon').value = '';
        }
        if(kind==='ship') {
            document.getElementById('hidShip').value = '';
        }

        // Submit form apply-coupons để refresh
        applyForm.submit();
    }
</script>
</body>
</html>