<!-- templates/customer/menu.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Menu | UTeaDrink</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/customer.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- CSRF (nếu bật Spring Security) -->
    <meta name="_csrf_parameter" th:content="${_csrf != null ? _csrf.parameterName : '_csrf'}">
    <meta name="_csrf_header"    th:content="${_csrf != null ? _csrf.headerName    : 'X-CSRF-TOKEN'}">
    <meta name="_csrf"           th:content="${_csrf != null ? _csrf.token         : ''}">

    <style>
        :root{ --accent:#e53935; --text:#111; --card:#e9e9ea; --ring:#e5e7eb; --header-h:80px; --tab-h:56px; }
        body.menu-page{ background:#fff; color:var(--text); padding-top:var(--header-h); }

        /* HERO */
        #heroCarousel{ margin-top:0; }
        .hero-img{ width:100%; height:360px; object-fit:cover; display:block; }
        @media (max-width:768px){ .hero-img{ height:240px } }

        /* TABS */
        .menu-tabs-wrap{ position:sticky; top:var(--header-h); z-index:1020; background:#fff; border-bottom:1px solid #eee; }
        .menu-tabs{ height:var(--tab-h); display:flex; align-items:center; justify-content:center; gap:22px; max-width:980px; margin:0 auto; overflow:auto; scrollbar-width:none }
        .menu-tab{ background:transparent!important; color:#6b7280!important; font-weight:700; text-decoration:none!important;
            padding:10px 14px; border-bottom:3px solid transparent; transition:color .2s, border-color .2s; white-space:nowrap }
        .menu-tab:hover{ color:#111!important; border-bottom-color:#111; }
        .menu-tab.active{ color:#111!important; border-bottom-color:#111!important; }

        /* GRID */
        section.menu-section{ scroll-margin-top:calc(var(--header-h) + var(--tab-h) + 18px); padding-top:8px; }
        section.menu-section + section.menu-section{ margin-top:34px; padding-top:24px; border-top:1px solid #eee; }
        .section-title{ font-size:1.45rem; font-weight:800; margin:0 0 18px; }

        .product-grid{ display:grid; gap:22px; grid-template-columns:1fr; }
        @media (min-width:768px){ .product-grid{ grid-template-columns:repeat(2,1fr); } }
        @media (min-width:992px){ .product-grid{ grid-template-columns:repeat(3,1fr); } }

        .product-card{
            --media:220px;
            background:var(--card);
            border:1px solid var(--ring);
            border-radius:14px;
            padding:16px 18px;
            display:grid;
            grid-template-columns: 1.35fr var(--media);
            align-items:center;
            gap:16px;
            width:100%;
            transition:transform .2s, box-shadow .2s, border-color .2s;
            cursor:pointer;
            position:relative; /* để đặt nút tuyệt đối */
            outline: none;
        }
        .product-card:hover{ transform:translateY(-4px); box-shadow:0 10px 20px rgba(0,0,0,.08); border-color:#dcdfe3; }

        .product-name{ font-weight:800; font-size:1rem; line-height:1.25; margin:0 0 4px; }
        .product-price{ color:var(--accent); font-weight:800; font-size:1.08rem; margin:0 0 6px; }
        .product-desc{ color:#222; font-size:.88rem; line-height:1.35; margin:0; max-width:48ch;
            display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
        .product-thumb{
            width:var(--media); height:var(--media);
            object-fit:contain; background:var(--card);
            border-radius:14px; justify-self:end; margin-right:-6px;
        }
        @media (max-width:640px){
            .product-card{ grid-template-columns:1fr; gap:14px; }
            .product-thumb{ width:200px; height:200px; justify-self:center; margin-right:0; }
        }

        .container-narrow{ max-width:1200px; margin:0 auto; padding:0 12px; }
        .pag-wrap{ display:flex; gap:6px; margin-top:14px; flex-wrap:wrap }
        .pag-wrap .btn{ border-radius:10px; }

        /* Nút Thêm nhanh – DƯỚI PHẢI */
        .quick-add{
            position:absolute;
            right:12px; bottom:12px;
            width:40px; height:40px; border-radius:12px;
            display:inline-flex; align-items:center; justify-content:center;
            border:none; background:#111; color:#fff; cursor:pointer;
            box-shadow:0 8px 20px rgba(0,0,0,.15);
            opacity:0; transform:translateY(6px); transition:opacity .18s, transform .18s;
        }
        .product-card:hover .quick-add{ opacity:1; transform:translateY(0); }
        .quick-add:active{ transform:scale(.96); }
        .quick-add i{ font-size:18px; line-height:1; }
        @media (hover:none){ .quick-add{ opacity:1; transform:none; } }

        /* FAB tìm kiếm */
        .search-fab{
            position:fixed; right:18px; bottom:18px; z-index:1090;
            width:54px; height:54px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            border:none; background:#111; color:#fff; box-shadow:0 10px 20px rgba(0,0,0,.2);
        }
        .search-fab i{ font-size:22px }

        /* Overlay + Modal search */
        .sr-overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1085; display:flex; align-items:flex-start; justify-content:center; padding:24px 12px; overflow:auto}
        .sr-overlay.d-none{display:none}
        .sr-modal{width:min(1200px,100%); background:#fff; border-radius:18px; padding:20px 22px; box-shadow:0 30px 60px rgba(0,0,0,.25)}
        .sr-bar{display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; border-radius:999px; padding:10px 14px; margin-bottom:14px}
        .sr-bar input{border:none; outline:none; flex:1; font-size:1.05rem}
        .icon-btn{background:transparent; border:0; color:#111; opacity:.6; cursor:pointer}
        .icon-btn:hover{opacity:1}
        .sr-title{font-size:1.25rem; font-weight:800; margin:10px 0 14px}

        /* Toast nhỏ */
        .toast-lite{position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
            background:#111; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 20px rgba(0,0,0,.25); z-index:1100; }
        .toast-lite.show{animation:toastIn .18s ease-out, toastOut .18s ease-in 2.1s forwards}
        @keyframes toastIn{from{opacity:0; transform:translate(-50%,8px)} to{opacity:1; transform:translate(-50%,0)}}
        @keyframes toastOut{to{opacity:0; transform:translate(-50%,8px)}}
    </style>
</head>

<body class="menu-page">

<div th:replace="~{fragments/header :: header}"></div>

<!-- Hero Slider -->
<section id="heroCarousel" class="carousel slide" data-bs-ride="carousel"
         th:with="hasBanner=${banners != null and !banners.isEmpty()}">

    <div class="carousel-indicators" th:if="${hasBanner}">
        <button type="button" data-bs-target="#heroCarousel"
                th:each="b,idx : ${banners}"
                th:data-bs-slide-to="${idx.index}"
                th:classappend="${idx.index == 0} ? ' active'"
                th:aria-current="${idx.index == 0} ? 'true' : null"
                th:aria-label="|Slide ${idx.index + 1}|"></button>
    </div>

    <div class="carousel-inner" th:if="${hasBanner}">
        <div class="carousel-item" th:each="b,idx : ${banners}" th:classappend="${idx.index == 0} ? ' active'">
            <a th:if="${b.link != null and !#strings.isEmpty(b.link)}" th:href="${b.link}">
                <img th:src="${b.imageUrl}" class="d-block w-100 hero-img" th:alt="${b.title != null ? b.title : 'UTeaDrink Banner'}">
            </a>
            <img th:if="${b.link == null or #strings.isEmpty(b.link)}"
                 th:src="${b.imageUrl}" class="d-block w-100 hero-img"
                 th:alt="${b.title != null ? b.title : 'UTeaDrink Banner'}">

            <div class="carousel-caption d-flex flex-column justify-content-center align-items-center text-center"
                 th:if="${b.title != null and !#strings.isEmpty(b.title)}">
                <h2 th:text="${b.title}"></h2>
            </div>
        </div>
    </div>

    <div class="carousel-inner" th:if="${!hasBanner}">
        <div class="carousel-item active">
            <img src="https://res.cloudinary.com/dhmh2ekqy/image/upload/v1760047323/1-tuan-nen-uong-bao-nhieu-tra-sua-1000x690_slbfnn.jpg" class="d-block w-100 hero-img" alt="UTeaDrink">
        </div>
        <div class="carousel-item">
            <img src="https://res.cloudinary.com/dhmh2ekqy/image/upload/v1760047294/tra-sua-da-lat-topbanner_sdeac5.jpg" class="d-block w-100 hero-img" alt="UTeaDrink">
        </div>
    </div>

    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
    </button>
</section>

<!-- Tabs -->
<div class="menu-tabs-wrap">
    <nav class="menu-tabs" id="menuTabs">
        <a href="#best" class="menu-tab active">Best seller</a>
        <a class="menu-tab"
           th:each="c : ${categories}"
           th:href="|#cat-${c.id}|"
           th:text="${c.name}">Danh mục</a>
    </nav>
</div>

<div class="container-narrow">
    <!-- Best seller -->
    <section id="best" class="menu-section">
        <h2 class="section-title">Best seller</h2>

        <div class="product-grid" th:if="${bestSellers != null and !bestSellers.isEmpty()}">
            <article class="product-card"
                     th:each="p : ${bestSellers.content}"
                     th:onclick="|location.href='@{/customer/product/{id}(id=${p.id})}'|"
                     tabindex="0" aria-label="Xem chi tiết [[${p.name}]]">
                <div>
                    <div class="product-name" th:text="${p.name}">Tên SP</div>
                    <div class="product-price" th:text="${#numbers.formatDecimal(p.basePrice,0,'COMMA',0,'POINT')} + ' đ'">0 đ</div>
                    <p class="product-desc" th:text="${p.description}">Mô tả…</p>
                </div>
                <img class="product-thumb" th:src="${p.mainImageUrl}" th:alt="${p.name}">
                <button type="button" class="quick-add qa-quick" title="Thêm nhanh" th:data-pid="${p.id}" onclick="event.stopPropagation()">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </article>
        </div>

        <div class="pag-wrap" th:if="${bestSellers != null and bestSellers.totalPages > 1}">
            <a class="btn btn-outline-dark btn-sm"
               th:classappend="${bestSellers.isFirst()} ? ' disabled'"
               th:href="@{/customer/menu(page_best=${pageBest - 1 < 0 ? 0 : pageBest - 1})}">« Trước</a>

            <a class="btn btn-outline-dark btn-sm"
               th:each="i : ${#numbers.sequence(0, bestSellers.totalPages - 1)}"
               th:text="${i + 1}"
               th:classappend="${i == pageBest} ? ' active'"
               th:href="@{/customer/menu(page_best=${i})}">1</a>

            <a class="btn btn-outline-dark btn-sm"
               th:classappend="${bestSellers.isLast()} ? ' disabled'"
               th:href="@{/customer/menu(page_best=${pageBest + 1 >= bestSellers.totalPages ? bestSellers.totalPages - 1 : pageBest + 1})}">Sau »</a>
        </div>
    </section>

    <!-- Sections theo danh mục -->
    <section class="menu-section"
             th:each="c : ${categories}"
             th:with="page=${catPages[c.id]}, curr=${catPageNums[c.id]}"
             th:id="|cat-${c.id}|">
        <h2 class="section-title" th:text="${c.name}">Danh mục</h2>

        <div class="product-grid" th:if="${page != null and !page.isEmpty()}">
            <article class="product-card"
                     th:each="p : ${page.content}"
                     th:onclick="|location.href='@{/customer/product/{id}(id=${p.id})}'|"
                     tabindex="0" aria-label="Xem chi tiết [[${p.name}]]">
                <div>
                    <div class="product-name" th:text="${p.name}">Tên SP</div>
                    <div class="product-price" th:text="${#numbers.formatDecimal(p.basePrice,0,'COMMA',0,'POINT')} + ' đ'">0 đ</div>
                    <p class="product-desc" th:text="${p.description}">Mô tả…</p>
                </div>
                <img class="product-thumb" th:src="${p.mainImageUrl}" th:alt="${p.name}">
                <button type="button" class="quick-add qa-quick" title="Thêm nhanh" th:data-pid="${p.id}" onclick="event.stopPropagation()">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </article>
        </div>

        <div class="pag-wrap" th:if="${page != null and page.totalPages > 1}">
            <a class="btn btn-outline-dark btn-sm"
               th:classappend="${page.isFirst()} ? ' disabled'"
               th:href="|/customer/menu?page_c_${c.id}=${curr - 1 < 0 ? 0 : curr - 1}|">« Trước</a>

            <a class="btn btn-outline-dark btn-sm"
               th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
               th:text="${i + 1}"
               th:classappend="${i == curr} ? ' active'"
               th:href="|/customer/menu?page_c_${c.id}=${i}|">1</a>

            <a class="btn btn-outline-dark btn-sm"
               th:classappend="${page.isLast()} ? ' disabled'"
               th:href="|/customer/menu?page_c_${c.id}=${curr + 1 >= page.totalPages ? page.totalPages - 1 : curr + 1}|">Sau »</a>
        </div>
    </section>
</div>

<div style="height:60px"></div>
<div th:replace="~{fragments/footer-home :: siteFooter}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
<script>
    // Fit header height
    (function(){
        const header = document.querySelector('.navbar') || document.querySelector('header');
        function upd(){
            if(!header) return;
            const h = Math.round(header.offsetHeight || 80);
            document.documentElement.style.setProperty('--header-h', h + 'px');
        }
        window.addEventListener('load', upd);
        window.addEventListener('resize', upd);
    })();

    // Smooth scroll tabs
    document.querySelectorAll('.menu-tab').forEach(a=>{
        a.addEventListener('click',e=>{
            const id = a.getAttribute('href');
            if(id && id.startsWith('#')){
                e.preventDefault();
                const el = document.querySelector(id);
                if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
            }
        });
    });

    // Active tab by section in view
    const tabs=[...document.querySelectorAll('.menu-tab')];
    const map={ best:0 };
    document.querySelectorAll('.menu-tab').forEach((t,idx)=>{
        const href=t.getAttribute('href')||'';
        if(href.startsWith('#cat-')){ map[href.substring(1)] = idx; }
    });
    const io=new IntersectionObserver((entries)=>{
        entries.forEach(en=>{
            if(en.isIntersecting){
                tabs.forEach(t=>t.classList.remove('active'));
                const id=en.target.id;
                const idx=id==='best' ? 0 : map[id];
                if(idx!=null) tabs[idx].classList.add('active');
            }
        });
    },{rootMargin:'-40% 0px -55% 0px',threshold:0.01});
    document.querySelectorAll('section.menu-section').forEach(s=>io.observe(s));
</script>

<!-- ==== Search FAB + Modal + Toast ==== -->
<button id="searchFab" class="search-fab" aria-label="Tìm sản phẩm">
    <i class="bi bi-search"></i>
</button>

<div id="srOverlay" class="sr-overlay d-none" aria-hidden="true">
    <div class="sr-modal" role="dialog" aria-modal="true" aria-labelledby="srTitle">
        <div class="sr-bar">
            <i class="bi bi-search"></i>
            <input id="srInput" type="text" placeholder="Tìm theo tên sản phẩm..." autocomplete="off">
            <button id="srClear" class="icon-btn" title="Xóa"><i class="bi bi-x-circle"></i></button>
            <button id="srClose" class="icon-btn" title="Đóng"><i class="bi bi-x-lg"></i></button>
        </div>
        <h3 id="srTitle" class="sr-title">Kết quả tìm kiếm</h3>
        <div id="srGrid" class="product-grid"></div>
        <div id="srPag" class="pag-wrap"></div>
    </div>
</div>

<div id="toast" class="toast-lite d-none" role="status" aria-live="polite"></div>

<script>
    (function(){
        // ---- CSRF ----
        const CSRF = {
            header: document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN',
            token:  document.querySelector('meta[name="_csrf"]')?.content || ''
        };

        // ---- Elements ----
        const fab   = document.getElementById('searchFab');
        const ovl   = document.getElementById('srOverlay');
        const input = document.getElementById('srInput');
        const clear = document.getElementById('srClear');
        const closeBtn = document.getElementById('srClose');
        const grid  = document.getElementById('srGrid');
        const pag   = document.getElementById('srPag');
        const toast = document.getElementById('toast');

        let q = '', page = 0, totalPages = 0, debounceTimer;

        function openModal(){
            ovl.classList.remove('d-none');
            ovl.setAttribute('aria-hidden','false');
            setTimeout(()=>input.focus(), 50);
        }
        function closeModal(){
            ovl.classList.add('d-none');
            ovl.setAttribute('aria-hidden','true');
            input.value = ''; q=''; page=0; totalPages=0;
            grid.innerHTML=''; pag.innerHTML='';
        }

        fab.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        ovl.addEventListener('click', (e)=>{ if(e.target === ovl) closeModal(); });
        clear.addEventListener('click', ()=>{ input.value=''; q=''; page=0; doSearch(); });

        input.addEventListener('input', ()=>{
            q = input.value.trim();
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(()=>{ page=0; doSearch(); }, 220);
        });

        async function doSearch(){
            if(!q){ grid.innerHTML=''; pag.innerHTML=''; return; }
            grid.innerHTML = '<div class="text-muted p-3">Đang tìm…</div>';
            try{
                const res = await fetch(`/customer/search.json?q=${encodeURIComponent(q)}&page=${page}&size=12`);
                const data = await res.json();
                totalPages = data.totalPages || 0;
                renderResults(data.content || []);
                renderPagination();
            }catch(err){
                grid.innerHTML = '<div class="text-danger p-3">Lỗi tìm kiếm</div>';
            }
        }

        function money(v){ try{ return new Intl.NumberFormat('vi-VN').format(v) + ' đ'; }catch{return v+' đ'} }
        function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

        function renderResults(items){
            if(!items.length){ grid.innerHTML = '<div class="p-3 text-muted">Không có sản phẩm phù hợp.</div>'; return; }
            grid.innerHTML = items.map(p => `
          <article class="product-card" data-href="/customer/product/${p.id}">
            <div>
              <div class="product-name">${escapeHtml(p.name||'')}</div>
              <div class="product-price">${money(p.price||0)}</div>
            </div>
            <img class="product-thumb" src="${escapeHtml(p.imageUrl||'')}" alt="${escapeHtml(p.name||'')}">
            <button type="button" class="quick-add qa-quick" data-pid="${p.id}" title="Thêm nhanh" onclick="event.stopPropagation()">
              <i class="bi bi-plus-lg"></i>
            </button>
          </article>`).join('');
        }

        function renderPagination(){
            if(totalPages <= 1){ pag.innerHTML=''; return; }
            let html = '';
            const prev = Math.max(0, page-1), next = Math.min(totalPages-1, page+1);
            html += `<a class="btn btn-outline-dark btn-sm ${page===0?'disabled':''}" data-gopage="${prev}">« Trước</a>`;
            for(let i=0;i<totalPages;i++){
                html += `<a class="btn btn-outline-dark btn-sm ${i===page?'active':''}" data-gopage="${i}">${i+1}</a>`;
            }
            html += `<a class="btn btn-outline-dark btn-sm ${page===totalPages-1?'disabled':''}" data-gopage="${next}">Sau »</a>`;
            pag.innerHTML = html;
        }

        pag.addEventListener('click', (e)=>{
            const a = e.target.closest('[data-gopage]');
            if(!a) return;
            e.preventDefault();
            const p = +a.getAttribute('data-gopage');
            if(isNaN(p) || p===page) return;
            page = p; doSearch();
        });

        // Click trong modal: card => chi tiết; nút + => thêm nhanh
        grid.addEventListener('click', async (e)=>{
            const add = e.target.closest('.qa-quick');
            if(add){
                e.preventDefault(); e.stopPropagation();
                await quickAdd(add.getAttribute('data-pid'));
                return;
            }
            const card = e.target.closest('.product-card');
            if(card){
                const href = card.getAttribute('data-href');
                if(href) window.location = href;
            }
        });

        // Toàn trang: nút + trên card cũng dùng AJAX và không mở chi tiết
        document.addEventListener('click', async (e)=>{
            const add = e.target.closest('.qa-quick');
            if(!add) return;
            e.preventDefault();
            e.stopPropagation();
            await quickAdd(add.getAttribute('data-pid'));
        }, true);

        async function quickAdd(pid){
            try{
                const res = await fetch('/customer/cart/api/quick-add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                        [CSRF.header]: CSRF.token
                    },
                    body: new URLSearchParams({ productId: pid, quantity: '1' })
                });
                const data = await res.json();
                if(data && data.ok){ showToast('Đã thêm vào giỏ hàng'); }
                else{ showToast('Không thể thêm.', true); }
            }catch(err){ showToast('Có lỗi khi thêm.', true); }
        }

        function showToast(msg, isErr=false){
            toast.textContent = msg;
            toast.style.background = isErr ? '#b91c1c' : '#111';
            toast.classList.remove('d-none');
            // restart animation
            toast.classList.remove('show');
            void toast.offsetWidth;
            toast.classList.add('show');
            setTimeout(()=>{ toast.classList.add('d-none'); }, 2400);
        }

        // Enter/Space trên card ngoài trang -> mở chi tiết
        document.addEventListener('keydown', function(e){
            const card = e.target.closest('.product-card');
            if(!card) return;
            if (e.code === 'Enter' || e.code === 'Space'){
                // nếu đang focus vào nút + thì bỏ qua
                if (document.activeElement && document.activeElement.closest('.qa-quick')) return;
                e.preventDefault();
                card.click(); // kích hoạt th:onclick
            }
        });
    })();
</script>

</body>
</html>
