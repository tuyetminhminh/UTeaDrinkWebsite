<!-- templates/customer/menu.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Menu | UTeaDrink</title>

    <!-- Preconnect to CDNs for faster loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" th:href="@{/css/customer.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- CSRF (nếu bật Spring Security) -->
    <meta name="_csrf_parameter" th:content="${_csrf != null ? _csrf.parameterName : '_csrf'}">
    <meta name="_csrf_header"    th:content="${_csrf != null ? _csrf.headerName    : 'X-CSRF-TOKEN'}">
    <meta name="_csrf"           th:content="${_csrf != null ? _csrf.token         : ''}">

    <style>
        :root{ --accent:#e53935; --text:#111; --header-h:70px; --tab-h:56px; }
        body.menu-page{ background:#f8f9fa; color:var(--text); font-family: 'Segoe UI', Tahoma, sans-serif; }

        /* TABS */
        .menu-tabs-wrap{ position:sticky; top:var(--header-h); z-index:1020; background:#fff; border-bottom:1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .menu-tabs{ height:var(--tab-h); display:flex; align-items:center; justify-content:center; gap:22px; max-width:1200px; margin:0 auto; overflow:auto; scrollbar-width:none; padding: 0 12px; }
        .menu-tab{ background:transparent!important; color:#6b7280!important; font-weight:700; text-decoration:none!important;
            padding:10px 14px; border-bottom:3px solid transparent; transition:color .2s, border-color .2s; white-space:nowrap }
        .menu-tab:hover{ color:#111!important; border-bottom-color:#111; }
        .menu-tab.active{ color:#111!important; border-bottom-color:#111!important; }

        /* GRID - 4 sản phẩm/hàng như customer-home */
        section.menu-section{ scroll-margin-top:calc(var(--header-h) + var(--tab-h) + 18px); padding-top:24px; }
        section.menu-section + section.menu-section{ margin-top:34px; padding-top:24px; border-top:1px solid #eee; }
        .section-title{ font-size:1.5rem; font-weight:800; margin:0 0 20px; color: #0f172a; }

        .product-grid{
            display:grid;
            gap:20px;
            grid-template-columns:repeat(auto-fill, minmax(250px, 1fr));
        }
        @media (min-width:768px){ .product-grid{ grid-template-columns:repeat(2,1fr); } }
        @media (min-width:992px){ .product-grid{ grid-template-columns:repeat(3,1fr); } }
        @media (min-width:1200px){ .product-grid{ grid-template-columns:repeat(4,1fr); } }

        /* Product Card - Premium Style */
        .product-card-wrapper {
            position: relative;
        }

        .product-card{
            background: white;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid rgba(0,0,0,0.04);
        }
        .product-card:hover{
            transform:translateY(-8px);
            box-shadow:0 16px 32px rgba(0,0,0,.15);
            z-index: 10;
            border-color: rgba(229, 57, 53, 0.2);
            will-change: transform, box-shadow;
        }

        /* Product Image */
        .product-image-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 ratio */
            overflow: hidden;
            background: #f8f9fa;
        }

        .product-thumb{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.4s ease;
        }
        .product-card:hover .product-thumb{
            transform: scale(1.1);
            will-change: transform;
        }

        /* Product Badge */
        .product-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 0.35rem 0.7rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .product-badge.hot {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .product-badge.popular {
            background: linear-gradient(135deg, #ff6347 0%, #ff4500 100%);
            color: white;
        }

        /* Product Overlay */
        .product-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .product-card:hover .product-overlay {
            opacity: 1;
        }

        .btn-add-cart {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(229, 57, 53, 0.4);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .product-card:hover .btn-add-cart {
            transform: translateY(0) scale(1.05);
            box-shadow: 0 6px 20px rgba(229, 57, 53, 0.6);
        }

        .btn-add-cart:hover {
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
        }

        .btn-add-cart:active {
            transform: translateY(0) scale(0.95);
        }

        /* Product Info */
        .product-info {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .product-name{
            font-weight: 700;
            font-size: 1.05rem;
            line-height: 1.4;
            margin: 0 0 0.5rem;
            color: #1a1a1a;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.9rem;
            transition: color 0.3s;
        }

        .product-card:hover .product-name {
            color: var(--accent);
        }

        .product-price-row {
            margin: 0.5rem 0;
        }

        .product-price{
            color: var(--accent);
            font-weight: 800;
            font-size: 1.2rem;
            margin: 0;
            text-shadow: 0 1px 2px rgba(229, 57, 53, 0.1);
        }

        /* Rating */
        .product-rating {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin: 0.25rem 0;
        }

        .product-rating.no-rating {
            color: #999;
            font-style: italic;
            font-size: 0.75rem;
        }

        .product-rating .stars {
            color: #ffc107;
            display: flex;
            gap: 1px;
        }

        .product-rating .stars i {
            font-size: 0.85rem;
        }

        .product-rating .rating-number {
            font-weight: 600;
            color: #333;
            font-size: 0.85rem;
        }

        /* Stats */
        .product-stats {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: auto;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .sold-count {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: #f8f9fa;
            padding: 0.35rem 0.7rem;
            border-radius: 20px;
        }

        .sold-count i {
            color: #4caf50;
            font-size: 0.8rem;
        }

        .sold-count strong {
            color: #333;
            font-weight: 700;
        }

        .container-narrow{ max-width:1200px; margin:0 auto; padding:0 20px 40px; }

        /* Pagination */
        .pag-wrap{
            display:flex;
            gap:6px;
            margin-top:20px;
            flex-wrap:wrap;
            justify-content: center;
        }
        .pag-wrap .btn{
            border-radius:8px;
            min-width: 38px;
        }

        /* FAB tìm kiếm */
        .search-fab{
            position:fixed; right:20px; bottom:20px; z-index:1090;
            width:56px; height:56px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            border:none; background:#111; color:#fff;
            box-shadow:0 10px 20px rgba(0,0,0,.2);
            transition: all 0.3s ease;
        }
        .search-fab:hover{
            background:#333;
            transform: scale(1.1);
        }
        .search-fab i{ font-size:22px }

        /* Overlay + Modal search */
        .sr-overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1085; display:flex; align-items:flex-start; justify-content:center; padding:24px 12px; overflow:auto}
        .sr-overlay.d-none{display:none}
        .sr-modal{width:min(1200px,100%); background:#fff; border-radius:18px; padding:20px 22px; box-shadow:0 30px 60px rgba(0,0,0,.25)}
        .sr-bar{display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; border-radius:999px; padding:10px 14px; margin-bottom:14px}
        .sr-bar input{border:none; outline:none; flex:1; font-size:1.05rem}
        .icon-btn{background:transparent; border:0; color:#111; opacity:.6; cursor:pointer}
        .icon-btn:hover{opacity:1}
        .sr-title{font-size:1.25rem; font-weight:800; margin:10px 0 14px}

        /* Toast notification */
        .toast-lite{
            position:fixed;
            left:50%;
            bottom:24px;
            transform:translateX(-50%);
            background:#111;
            color:#fff;
            padding:12px 20px;
            border-radius:12px;
            box-shadow:0 12px 24px rgba(0,0,0,.3);
            z-index:1100;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast-lite.show{animation:toastIn .2s ease-out, toastOut .2s ease-in 2.1s forwards}
        @keyframes toastIn{from{opacity:0; transform:translate(-50%,12px)} to{opacity:1; transform:translate(-50%,0)}}
        @keyframes toastOut{to{opacity:0; transform:translate(-50%,12px)}}
    </style>
</head>

<body class="menu-page">

<div th:replace="~{fragments/header-customer :: customerHeader}"></div>

<!-- Tabs -->
<div class="menu-tabs-wrap">
    <nav class="menu-tabs" id="menuTabs">
        <a href="#best" class="menu-tab active">Best seller</a>
        <a class="menu-tab"
           th:each="c : ${categories}"
           th:href="|#cat-${c.id}|"
           th:text="${c.name}">Danh mục</a>
    </nav>
</div>

<div class="container-narrow">
    <!-- Best seller -->
    <section id="best" class="menu-section">
        <h2 class="section-title">Best seller</h2>

        <div class="product-grid" th:if="${bestSellers != null and !bestSellers.isEmpty()}">
            <article class="product-card"
                     th:each="p : ${bestSellers.content}"
                     th:with="actualRating=${ratingMap[p.id]}, actualSold=${soldMap[p.id]}"
                     th:onclick="|location.href='@{/customer/product/{id}(id=${p.id})}'|"
                     tabindex="0" aria-label="Xem chi tiết [[${p.name}]]">
                <div class="product-image-container">
                    <!-- Badge -->
                    <div th:if="${actualSold != null and actualSold > 100}" class="product-badge hot">
                        <i class="fas fa-fire"></i> Bán chạy
                    </div>
                    <div th:if="${actualSold != null and actualSold > 50 and actualSold <= 100}" class="product-badge popular">
                        <i class="fas fa-heart"></i> Yêu thích
                    </div>

                    <img th:src="${p.mainImageUrl}"
                         class="product-thumb"
                         th:alt="${p.name}"
                         loading="lazy"
                         onerror="this.src='https://via.placeholder.com/300x300/f5f5f5/999999?text=No+Image'">

                    <div class="product-overlay">
                        <button class="btn-add-cart" th:data-pid="${p.id}" onclick="event.stopPropagation(); addToCart(this.getAttribute('data-pid'))">
                            <i class="fas fa-shopping-cart"></i> Thêm nhanh vào giỏ
                        </button>
                    </div>
                </div>

                <div class="product-info">
                    <h3 class="product-name" th:text="${p.name}">Tên SP</h3>
                    <div class="product-price-row">
                        <span class="product-price" th:text="${#numbers.formatDecimal(p.basePrice,0,'COMMA',0,'POINT')} + ' đ'">0 đ</span>
                    </div>

                    <!-- Rating -->
                    <div th:if="${actualRating != null}" class="product-rating">
                        <span class="stars">
                            <i th:each="i : ${#numbers.sequence(1, 5)}"
                               th:classappend="${i <= actualRating} ? 'fas fa-star' : (${i - 0.5 <= actualRating} ? 'fas fa-star-half-alt' : 'far fa-star')"></i>
                        </span>
                        <span class="rating-number" th:text="${#numbers.formatDecimal(actualRating, 1, 1)}">0.0</span>
                    </div>
                    <div th:if="${actualRating == null}" class="product-rating no-rating">
                        <i class="far fa-star-half"></i>
                        <span class="text-muted">Chưa có đánh giá</span>
                    </div>

                    <!-- Sold count -->
                    <div class="product-stats">
                        <span class="sold-count">
                            <i class="fas fa-shopping-cart"></i>
                            Đã bán: <strong th:text="${actualSold != null ? actualSold : 0}">0</strong>
                        </span>
                    </div>
                </div>
            </article>
        </div>

        <div class="pag-wrap" th:if="${bestSellers != null and bestSellers.totalPages > 1}">
            <a class="btn btn-outline-dark btn-sm"
               th:classappend="${bestSellers.isFirst()} ? ' disabled'"
               th:href="@{/customer/menu(page_best=${pageBest - 1 < 0 ? 0 : pageBest - 1})}">« Trước</a>

            <a class="btn btn-outline-dark btn-sm"
               th:each="i : ${#numbers.sequence(0, bestSellers.totalPages - 1)}"
               th:text="${i + 1}"
               th:classappend="${i == pageBest} ? ' active'"
               th:href="@{/customer/menu(page_best=${i})}">1</a>

            <a class="btn btn-outline-dark btn-sm"
               th:classappend="${bestSellers.isLast()} ? ' disabled'"
               th:href="@{/customer/menu(page_best=${pageBest + 1 >= bestSellers.totalPages ? bestSellers.totalPages - 1 : pageBest + 1})}">Sau »</a>
        </div>
    </section>

    <!-- Sections theo danh mục -->
    <section class="menu-section"
             th:each="c : ${categories}"
             th:with="page=${catPages[c.id]}, curr=${catPageNums[c.id]}"
             th:id="|cat-${c.id}|">
        <h2 class="section-title" th:text="${c.name}">Danh mục</h2>

        <div class="product-grid" th:if="${page != null and !page.isEmpty()}">
            <article class="product-card"
                     th:each="p : ${page.content}"
                     th:with="actualRating=${ratingMap[p.id]}, actualSold=${soldMap[p.id]}"
                     th:onclick="|location.href='@{/customer/product/{id}(id=${p.id})}'|"
                     tabindex="0" aria-label="Xem chi tiết [[${p.name}]]">
                <div class="product-image-container">
                    <!-- Badge -->
                    <div th:if="${actualSold != null and actualSold > 100}" class="product-badge hot">
                        <i class="fas fa-fire"></i> Bán chạy
                    </div>
                    <div th:if="${actualSold != null and actualSold > 50 and actualSold <= 100}" class="product-badge popular">
                        <i class="fas fa-heart"></i> Yêu thích
                    </div>

                    <img th:src="${p.mainImageUrl}"
                         class="product-thumb"
                         th:alt="${p.name}"
                         loading="lazy"
                         onerror="this.src='https://via.placeholder.com/300x300/f5f5f5/999999?text=No+Image'">

                    <div class="product-overlay">
                        <button class="btn-add-cart" th:data-pid="${p.id}" onclick="event.stopPropagation(); addToCart(this.getAttribute('data-pid'))">
                            <i class="fas fa-shopping-cart"></i> Thêm nhanh vào giỏ
                        </button>
                    </div>
                </div>

                <div class="product-info">
                    <h3 class="product-name" th:text="${p.name}">Tên SP</h3>
                    <div class="product-price-row">
                        <span class="product-price" th:text="${#numbers.formatDecimal(p.basePrice,0,'COMMA',0,'POINT')} + ' đ'">0 đ</span>
                    </div>

                    <!-- Rating -->
                    <div th:if="${actualRating != null}" class="product-rating">
                        <span class="stars">
                            <i th:each="i : ${#numbers.sequence(1, 5)}"
                               th:classappend="${i <= actualRating} ? 'fas fa-star' : (${i - 0.5 <= actualRating} ? 'fas fa-star-half-alt' : 'far fa-star')"></i>
                        </span>
                        <span class="rating-number" th:text="${#numbers.formatDecimal(actualRating, 1, 1)}">0.0</span>
                    </div>
                    <div th:if="${actualRating == null}" class="product-rating no-rating">
                        <i class="far fa-star-half"></i>
                        <span class="text-muted">Chưa có đánh giá</span>
                    </div>

                    <!-- Sold count -->
                    <div class="product-stats">
                        <span class="sold-count">
                            <i class="fas fa-shopping-cart"></i>
                            Đã bán: <strong th:text="${actualSold != null ? actualSold : 0}">0</strong>
                        </span>
                    </div>
                </div>
            </article>
        </div>

        <div class="pag-wrap" th:if="${page != null and page.totalPages > 1}">
            <a class="btn btn-outline-dark btn-sm"
               th:classappend="${page.isFirst()} ? ' disabled'"
               th:href="|/customer/menu?page_c_${c.id}=${curr - 1 < 0 ? 0 : curr - 1}|">« Trước</a>

            <a class="btn btn-outline-dark btn-sm"
               th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
               th:text="${i + 1}"
               th:classappend="${i == curr} ? ' active'"
               th:href="|/customer/menu?page_c_${c.id}=${i}|">1</a>

            <a class="btn btn-outline-dark btn-sm"
               th:classappend="${page.isLast()} ? ' disabled'"
               th:href="|/customer/menu?page_c_${c.id}=${curr + 1 >= page.totalPages ? page.totalPages - 1 : curr + 1}|">Sau »</a>
        </div>
    </section>
</div>

<div th:replace="~{fragments/footer-home :: siteFooter}"></div>

<!-- AI Chatbot Widget -->
<div th:replace="~{fragments/ai-chatbot-widget :: aiChatbot}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
<script>
    // ==== CSRF TOKEN (GLOBAL) ====
    const CSRF = {
        header: document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN',
        token:  document.querySelector('meta[name="_csrf"]')?.content || ''
    };

    // Fit header height
    (function(){
        const header = document.querySelector('.navbar') || document.querySelector('header');
        function upd(){
            if(!header) return;
            const h = Math.round(header.offsetHeight || 80);
            document.documentElement.style.setProperty('--header-h', h + 'px');
        }
        window.addEventListener('load', () => {
            upd();
            console.log('✅ Menu page loaded successfully');
        });
        window.addEventListener('resize', upd);
    })();

    // Smooth scroll tabs
    document.querySelectorAll('.menu-tab').forEach(a=>{
        a.addEventListener('click',e=>{
            const id = a.getAttribute('href');
            if(id && id.startsWith('#')){
                e.preventDefault();
                const el = document.querySelector(id);
                if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
            }
        });
    });

    // Active tab by section in view (optimized)
    (function(){
        const tabs=[...document.querySelectorAll('.menu-tab')];
        if(!tabs.length) return;

        const map={ best:0 };
        tabs.forEach((t,idx)=>{
            const href=t.getAttribute('href')||'';
            if(href.startsWith('#cat-')){ map[href.substring(1)] = idx; }
        });

        let activeIdx = -1;
        const io=new IntersectionObserver((entries)=>{
            entries.forEach(en=>{
                if(en.isIntersecting){
                    const id=en.target.id;
                    const idx=id==='best' ? 0 : map[id];
                    if(idx!=null && idx !== activeIdx) {
                        activeIdx = idx;
                        tabs.forEach((t,i)=>t.classList.toggle('active', i===idx));
                    }
                }
            });
        },{rootMargin:'-40% 0px -55% 0px',threshold:0.01});

        document.querySelectorAll('section.menu-section').forEach(s=>io.observe(s));
    })();
</script>

<!-- ==== Search FAB + Modal + Toast ==== -->
<button id="searchFab" class="search-fab" aria-label="Tìm sản phẩm">
    <i class="bi bi-search"></i>
</button>

<div id="srOverlay" class="sr-overlay d-none" aria-hidden="true">
    <div class="sr-modal" role="dialog" aria-modal="true" aria-labelledby="srTitle">
        <div class="sr-bar">
            <i class="bi bi-search"></i>
            <input id="srInput" type="text" placeholder="Tìm theo tên sản phẩm..." autocomplete="off">
            <button id="srClear" class="icon-btn" title="Xóa"><i class="bi bi-x-circle"></i></button>
            <button id="srClose" class="icon-btn" title="Đóng"><i class="bi bi-x-lg"></i></button>
        </div>
        <h3 id="srTitle" class="sr-title">Kết quả tìm kiếm</h3>
        <div id="srGrid" class="product-grid"></div>
        <div id="srPag" class="pag-wrap"></div>
    </div>
</div>

<div id="toast" class="toast-lite d-none" role="status" aria-live="polite"></div>

<script>
    (function(){
        // ---- Elements ----
        const fab   = document.getElementById('searchFab');
        const ovl   = document.getElementById('srOverlay');
        const input = document.getElementById('srInput');
        const clear = document.getElementById('srClear');
        const closeBtn = document.getElementById('srClose');
        const grid  = document.getElementById('srGrid');
        const pag   = document.getElementById('srPag');
        const toast = document.getElementById('toast');

        let q = '', page = 0, totalPages = 0, debounceTimer;

        function openModal(){
            ovl.classList.remove('d-none');
            ovl.setAttribute('aria-hidden','false');
            setTimeout(()=>input.focus(), 50);
        }
        function closeModal(){
            ovl.classList.add('d-none');
            ovl.setAttribute('aria-hidden','true');
            input.value = ''; q=''; page=0; totalPages=0;
            grid.innerHTML=''; pag.innerHTML='';
            clearTimeout(debounceTimer); // Stop any pending searches
        }

        fab.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        ovl.addEventListener('click', (e)=>{ if(e.target === ovl) closeModal(); });
        clear.addEventListener('click', ()=>{ input.value=''; q=''; page=0; doSearch(); });

        input.addEventListener('input', ()=>{
            q = input.value.trim();
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(()=>{ page=0; doSearch(); }, 220);
        });

        async function doSearch(){
            if(!q){ grid.innerHTML=''; pag.innerHTML=''; return; }
            grid.innerHTML = '<div class="text-muted p-3">Đang tìm…</div>';
            try{
                const res = await fetch(`/customer/search.json?q=${encodeURIComponent(q)}&page=${page}&size=12`);
                const data = await res.json();
                totalPages = data.totalPages || 0;
                renderResults(data.content || []);
                renderPagination();
            }catch(err){
                grid.innerHTML = '<div class="text-danger p-3">Lỗi tìm kiếm</div>';
            }
        }

        function money(v){ try{ return new Intl.NumberFormat('vi-VN').format(v) + ' đ'; }catch{return v+' đ'} }
        function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

        function renderResults(items){
            if(!items.length){ grid.innerHTML = '<div class="p-3 text-muted">Không có sản phẩm phù hợp.</div>'; return; }
            grid.innerHTML = items.map(p => {
                const rating = p.ratingAvg ? parseFloat(p.ratingAvg) : 0;
                const soldCount = p.soldCount ? parseInt(p.soldCount) : 0;

                // Render stars
                let starsHTML = '';
                if (rating > 0) {
                    const fullStars = Math.floor(rating);
                    const hasHalfStar = rating % 1 >= 0.5;
                    for (let i = 0; i < 5; i++) {
                        if (i < fullStars) {
                            starsHTML += '<i class="fas fa-star"></i>';
                        } else if (i === fullStars && hasHalfStar) {
                            starsHTML += '<i class="fas fa-star-half-alt"></i>';
                        } else {
                            starsHTML += '<i class="far fa-star"></i>';
                        }
                    }
                }

                const ratingDisplay = rating > 0
                    ? `<div class="product-rating">
                         <span class="stars">${starsHTML}</span>
                         <span class="rating-number">${rating.toFixed(1)}</span>
                       </div>`
                    : `<div class="product-rating no-rating">
                         <i class="far fa-star-half"></i>
                         <span class="text-muted">Chưa có đánh giá</span>
                       </div>`;

                let badge = '';
                if (soldCount > 100) {
                    badge = '<div class="product-badge hot"><i class="fas fa-fire"></i> Bán chạy</div>';
                } else if (soldCount > 50) {
                    badge = '<div class="product-badge popular"><i class="fas fa-heart"></i> Yêu thích</div>';
                }

                return `
          <article class="product-card" data-href="/customer/product/${p.id}">
                    <div class="product-image-container">
                      ${badge}
                      <img class="product-thumb" src="${escapeHtml(p.imageUrl||'')}" alt="${escapeHtml(p.name||'')}"
                           loading="lazy"
                           onerror="this.src='https://via.placeholder.com/300x300/f5f5f5/999999?text=No+Image'">
                      <div class="product-overlay">
                        <button class="btn-add-cart" data-pid="${p.id}" onclick="event.stopPropagation(); addToCart(${p.id})">
                          <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                        </button>
                      </div>
                    </div>
                    <div class="product-info">
                      <h3 class="product-name">${escapeHtml(p.name||'')}</h3>
                      <div class="product-price-row">
                        <span class="product-price">${money(p.price||0)}</span>
                      </div>
                      ${ratingDisplay}
                      <div class="product-stats">
                        <span class="sold-count">
                          <i class="fas fa-shopping-cart"></i>
                          Đã bán: <strong>${soldCount}</strong>
                        </span>
                      </div>
            </div>
                  </article>`;
            }).join('');
        }

        function renderPagination(){
            if(totalPages <= 1){ pag.innerHTML=''; return; }
            let html = '';
            const prev = Math.max(0, page-1), next = Math.min(totalPages-1, page+1);
            html += `<a class="btn btn-outline-dark btn-sm ${page===0?'disabled':''}" data-gopage="${prev}">« Trước</a>`;
            for(let i=0;i<totalPages;i++){
                html += `<a class="btn btn-outline-dark btn-sm ${i===page?'active':''}" data-gopage="${i}">${i+1}</a>`;
            }
            html += `<a class="btn btn-outline-dark btn-sm ${page===totalPages-1?'disabled':''}" data-gopage="${next}">Sau »</a>`;
            pag.innerHTML = html;
        }

        pag.addEventListener('click', (e)=>{
            const a = e.target.closest('[data-gopage]');
            if(!a) return;
            e.preventDefault();
            const p = +a.getAttribute('data-gopage');
            if(isNaN(p) || p===page) return;
            page = p; doSearch();
        });

        // Click trong modal: card => chi tiết
        grid.addEventListener('click', (e)=>{
            const card = e.target.closest('.product-card');
            if (card && !e.target.closest('.btn-add-cart')) {
                const href = card.getAttribute('data-href');
                if (href) window.location = href;
            }
        });

    })();

    // ==== ADD TO CART FUNCTION ====
    async function addToCart(pid) {
        try {
            const res = await fetch('/customer/cart/api/quick-add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                    [CSRF.header]: CSRF.token || ''
                },
                body: new URLSearchParams({ productId: pid, quantity: '1' })
            });

            // 1) Chưa đăng nhập
            if (res.status === 401) {
                showToast('Vui lòng đăng nhập để thêm vào giỏ', true);
                setTimeout(() => window.location = '/login', 700);
                return;
            }

            // 2) Redirect/HTML response
            const ct = res.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                showToast('Phiên đăng nhập hết hạn. Đang chuyển trang...', true);
                setTimeout(() => window.location = '/login', 700);
                return;
            }

            // 3) JSON response
            const data = await res.json();

            if (data.ok === true) {
                showToast('✓ Đã thêm vào giỏ hàng');
                return;
            }

            // 4) Handle specific reasons
            switch (data.reason) {
                case 'REQUIRES_OPTIONS':
                    showToast('Sản phẩm cần chọn size/tùy chọn', true);
                    setTimeout(() => window.location = `/customer/product/${pid}`, 500);
                    break;
                case 'OUT_OF_STOCK':
                    showToast('Sản phẩm đã hết hàng', true);
                    break;
                case 'NOT_FOUND':
                    showToast('Sản phẩm không tồn tại', true);
                    break;
                default:
                    showToast('Không thể thêm vào giỏ', true);
            }
        } catch (err) {
            console.error(err);
            showToast('Có lỗi xảy ra. Vui lòng thử lại', true);
        }
    }

    let toastTimer = null;
    function showToast(msg, isErr = false) {
        const toast = document.getElementById('toast');
        if (!toast) return;

        // Clear previous timer
        if (toastTimer) clearTimeout(toastTimer);

        toast.textContent = msg;
        toast.style.background = isErr ? '#b91c1c' : '#10b981';
        toast.classList.remove('d-none');
        toast.classList.remove('show');
        void toast.offsetWidth;
        toast.classList.add('show');

        toastTimer = setTimeout(() => {
            toast.classList.add('d-none');
            toastTimer = null;
        }, 2400);
    }
</script>

</body>
</html>
