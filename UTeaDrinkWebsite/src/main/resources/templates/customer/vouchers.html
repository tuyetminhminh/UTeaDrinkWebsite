<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Kho Voucher của tôi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root{--bg:#f6f7f9;--ink:#0f172a;--line:#e9edf1;--radius:14px;--elev:0 6px 16px rgba(15,23,42,.05)}
        body{background:var(--bg);color:var(--ink);padding-top:64px}
        .wrap{max-width:1000px;margin:24px auto;padding:0 12px}
        .panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--elev)}
        .panel-bd{padding:16px}
        .tabs{display:flex;gap:18px;align-items:center;white-space:nowrap;overflow:auto}
        .tab{padding:10px 0;color:#334155;text-decoration:none;font-weight:700;border-bottom:2px solid transparent}
        .tab.active{color:#111;border-color:#111}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        @media (max-width: 768px){ .grid{grid-template-columns:1fr} }
        .voucher{display:flex;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff;box-shadow:var(--elev)}
        .v-left{width:160px;background:#ffedd5;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:14px}
        .v-right{flex:1;padding:14px 16px}
        .v-title{font-weight:800;font-size:1.05rem}
        .v-meta{color:#64748b;font-size:.9rem}
        .v-tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 10px;font-size:.75rem;margin-right:6px}
        .voucher.border-success{ box-shadow:0 8px 20px rgba(16,185,129,.15); }
    </style>
</head>
<body>

<!-- giữ nguyên header -->
<div th:replace="~{fragments/header-customer :: customerHeader}"></div>

<div class="wrap">
    <h2 class="fw-bold">Kho voucher của tôi</h2>
    <div class="text-muted mb-3">Tab <strong>Đã lưu</strong> hiển thị các mã của riêng bạn.</div>

    <!-- Nhập mã để lưu -->
    <div class="panel mb-3">
        <div class="panel-bd">
            <form class="d-flex gap-2 align-items-center" th:action="@{/customer/vouchers/save}" method="post">
                <input type="hidden" name="sort"  th:value="${sort}">
                <input type="hidden" name="q"     th:value="${q}">
                <input type="hidden" name="saved" th:value="${saved}">
                <label class="form-label m-0">Mã Voucher</label>
                <input class="form-control" type="text" name="code" placeholder="Nhập mã voucher tại đây">
                <!-- CSRF optional -->
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn btn-dark" type="submit">Lưu</button>
            </form>
        </div>
    </div>

    <!-- Tabs + tìm + sort -->
    <div class="panel mb-3">
        <div class="panel-bd d-flex flex-column gap-2">
            <div class="tabs">
                <a class="tab"
                   th:classappend="${saved == false} ? ' active' : ''"
                   th:href="@{/customer/vouchers(saved=false, q=${q}, sort=${sort}, page=0, size=10)}">Tất cả</a>
                <a class="tab"
                   th:classappend="${saved == true} ? ' active' : ''"
                   th:href="@{/customer/vouchers(saved=true, q=${q}, sort=${sort}, page=0, size=10)}">
                    Đã lưu (<span th:text="${savedCount}">0</span>)
                </a>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <form class="d-inline-flex align-items-center gap-2" method="get" th:action="@{/customer/vouchers}">
                    <input type="hidden" name="saved" th:value="${saved}">
                    <input type="hidden" name="size"  value="10">
                    <input type="hidden" name="page"  value="0">
                    <input class="form-control form-control-sm" style="min-width:220px"
                           type="text" name="q" placeholder="Tìm theo mã" th:value="${q}">
                    <select class="form-select form-select-sm" name="sort" onchange="this.form.submit()">
                        <option value="newest"     th:selected="${sort=='newest'}">Mới nhất</option>
                        <option value="oldest"     th:selected="${sort=='oldest'}">Cũ nhất</option>
                        <option value="savedfirst" th:selected="${sort=='savedfirst'}">Ưu tiên đã lưu</option>
                    </select>
                    <button class="btn btn-outline-secondary btn-sm" type="submit">Lọc</button>
                </form>
                <div class="text-muted small">Đã lưu: <span th:text="${savedCount}">0</span> mã</div>
            </div>
        </div>
    </div>

    <!-- Danh sách -->
    <div class="grid" th:if="${items != null and items.totalElements > 0}">
        <div class="voucher" th:each="v : ${items.content}" th:classappend="${v.saved} ? ' border-success' : ''">
            <div class="v-left">
                <div class="fw-bold" th:text="${v.typeText}">Giảm %</div>
                <div class="text-uppercase small" th:text="${v.scope}">GLOBAL</div>
            </div>
            <div class="v-right">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="v-title"><span th:text="${v.code}">CODE123</span></div>
                    <div>
                        <span class="badge text-bg-success" th:if="${v.saved}" style="margin-right:6px;">ĐÃ LƯU</span>
                        <span class="v-tag" th:if="${v.shopName != null}" th:text="${v.shopName}">Shop</span>
                        <span class="v-tag" th:text="${v.status}">ACTIVE</span>
                    </div>
                </div>

                <div class="v-meta mt-1">
                    <span th:if="${v.percentOff != null}" th:text="'Giảm ' + ${v.percentOff} + '%'"></span>
                    <span th:if="${v.amountOff  != null}" th:text="'Giảm ' + ${#numbers.formatDecimal(v.amountOff,0,'COMMA',0,'POINT')} + 'đ'"></span>
                    <span th:if="${v.amountCap  != null}" class="ms-2"
                          th:text="'Tối đa ' + ${#numbers.formatDecimal(v.amountCap,0,'COMMA',0,'POINT')} + 'đ'"></span>
                    <span th:if="${v.freeShip}" class="ms-2">Miễn/giảm phí ship</span>
                    <span th:if="${v.minTotal   != null}" class="ms-2"
                          th:text="'Đơn tối thiểu ' + ${#numbers.formatDecimal(v.minTotal,0,'COMMA',0,'POINT')} + 'đ'"></span>
                </div>

                <div class="v-meta mt-1">
                    <span th:if="${v.activeFrom != null}" th:text="'Hiệu lực từ: ' + ${#temporals.format(v.activeFrom,'dd/MM HH:mm')}"></span>
                    <span th:if="${v.activeTo   != null}" class="ms-2"
                          th:text="'đến: ' + ${#temporals.format(v.activeTo,'dd/MM HH:mm')}"></span>
                </div>

                <div class="mt-2 d-flex gap-2">
                    <!-- ⬇⬇ ĐỔI sang cart -->
                    <a class="btn btn-outline-primary btn-sm"
                       th:href="@{/customer/cart(voucher=${v.code})}">
                        Dùng ngay
                    </a>

                    <!-- Lưu -->
                    <form th:if="${v.saved == false}" th:action="@{/customer/vouchers/save}" method="post">
                        <input type="hidden" name="saved" th:value="${saved}">
                        <input type="hidden" name="code"  th:value="${v.code}">
                        <input type="hidden" name="q"     th:value="${q}">
                        <input type="hidden" name="sort"  th:value="${sort}">
                        <input type="hidden" th:if="${_csrf != null}"
                               th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn btn-dark btn-sm" type="submit">Lưu</button>
                    </form>

                    <!-- Bỏ lưu -->
                    <form th:if="${v.saved == true}" th:action="@{/customer/vouchers/unsave}" method="post">
                        <input type="hidden" name="saved" th:value="${saved}">
                        <input type="hidden" name="code"  th:value="${v.code}">
                        <input type="hidden" name="q"     th:value="${q}">
                        <input type="hidden" name="sort"  th:value="${sort}">
                        <input type="hidden" th:if="${_csrf != null}"
                               th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn btn-outline-danger btn-sm" type="submit">Bỏ lưu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center text-muted py-5" th:if="${items == null or items.totalElements == 0}">
        Không có voucher phù hợp.
    </div>

    <!-- Phân trang -->
    <nav class="mt-3" th:if="${items != null and items.totalPages > 1}">
        <ul class="pagination pagination-sm justify-content-center">
            <li class="page-item" th:classappend="${items.first} ? ' disabled' : ''">
                <a class="page-link"
                   th:href="@{/customer/vouchers(q=${q}, saved=${saved}, sort=${sort}, page=${items.number-1}, size=10)}">«</a>
            </li>
            <li class="page-item"
                th:each="i : ${#numbers.sequence(0, items.totalPages-1)}"
                th:classappend="${i == items.number} ? ' active' : ''">
                <a class="page-link" th:text="${i+1}"
                   th:href="@{/customer/vouchers(q=${q}, saved=${saved}, sort=${sort}, page=${i}, size=10)}">1</a>
            </li>
            <li class="page-item" th:classappend="${items.last} ? ' disabled' : ''">
                <a class="page-link"
                   th:href="@{/customer/vouchers(q=${q}, saved=${saved}, sort=${sort}, page=${items.number+1}, size=10)}">»</a>
            </li>
        </ul>
    </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
